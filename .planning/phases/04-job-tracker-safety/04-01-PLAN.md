---
phase: 04-job-tracker-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/tracker.ts
  - src/lib/tracker/storage.ts
  - src/lib/tracker/utils.ts
autonomous: true

must_haves:
  truths:
    - "Applications can be saved to Chrome Storage"
    - "Applications can be retrieved from Chrome Storage"
    - "Application data persists across browser restarts"
    - "Duplicate applications can be detected"
  artifacts:
    - path: "src/types/tracker.ts"
      provides: "TrackedApplication type and Status enum"
      exports: ["TrackedApplication", "ApplicationStatus", "ATSPlatform"]
    - path: "src/lib/tracker/storage.ts"
      provides: "Chrome Storage operations for applications"
      exports: ["saveApplication", "getApplications", "updateApplication", "deleteApplication"]
      min_lines: 80
    - path: "src/lib/tracker/utils.ts"
      provides: "Date calculations and duplicate detection"
      exports: ["getTodayDateString", "isToday", "isDuplicate", "normalizeUrl"]
      min_lines: 40
  key_links:
    - from: "src/lib/tracker/storage.ts"
      to: "chrome.storage.local"
      via: "Chrome Storage API calls"
      pattern: "chrome\\.storage\\.local\\.(get|set)"
    - from: "src/lib/tracker/storage.ts"
      to: "src/types/tracker.ts"
      via: "TrackedApplication type import"
      pattern: "import.*TrackedApplication.*from.*types/tracker"
---

<objective>
Create the data layer for the job application tracker with Chrome Storage persistence and utility functions.

**Purpose:** Establish the foundation for tracking job applications locally with type-safe storage operations.

**Output:** Type definitions, Chrome Storage CRUD operations, and date/duplicate utilities that other tracker features will build upon.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/kittu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-job-tracker-safety/04-CONTEXT.md
@.planning/phases/04-job-tracker-safety/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create tracker types and enums</name>
  <files>src/types/tracker.ts</files>
  <action>
Create TypeScript types for job application tracking:

1. **TrackedApplication interface** with fields:
   - id: string (UUID)
   - jobTitle: string
   - company: string
   - atsType: 'workday' | 'greenhouse' | 'lever' | 'unknown'
   - url: string
   - appliedDate: string (ISO 8601 format)
   - status: ApplicationStatus enum value
   - notes?: string (optional)

2. **ApplicationStatus enum** with values:
   - Applied = 'applied'
   - Interview = 'interview'
   - Offer = 'offer'
   - Rejected = 'rejected'
   - Withdrawn = 'withdrawn'

3. **ATSPlatform type** as union type: 'workday' | 'greenhouse' | 'lever' | 'unknown'

4. **VolumeData interface** for 24h tracking:
   - date: string (YYYY-MM-DD format in user timezone)
   - count: number

Export all types. Follow existing project patterns from `src/types/profile.ts`.
  </action>
  <verify>
Run `pnpm type-check` - must pass with no errors.
Check that all exports are present: `grep "export" src/types/tracker.ts` shows TrackedApplication, ApplicationStatus, ATSPlatform, VolumeData.
  </verify>
  <done>
Types file exists with all required interfaces and enums. TypeScript compilation succeeds.
  </done>
</task>

<task type="auto">
  <name>Implement Chrome Storage operations for applications</name>
  <files>src/lib/tracker/storage.ts</files>
  <action>
Create Chrome Storage abstraction for tracked applications using patterns from research:

1. **saveApplication(app: TrackedApplication): Promise<void>**
   - Read existing applications array from chrome.storage.local.get('applications')
   - Check for duplicates using normalizeUrl (from utils.ts) before adding
   - Append new application to array
   - Write updated array to chrome.storage.local.set({ applications })
   - Handle empty initial state (applications = [])

2. **getApplications(): Promise<TrackedApplication[]>**
   - Read from chrome.storage.local.get('applications')
   - Return applications array (default to [] if not found)
   - Sort by appliedDate DESC (newest first)

3. **updateApplication(id: string, updates: Partial<TrackedApplication>): Promise<void>**
   - Read applications array
   - Find application by id
   - Merge updates into found application
   - Write updated array back to storage
   - Throw error if application not found

4. **deleteApplication(id: string): Promise<void>**
   - Read applications array
   - Filter out application with matching id
   - Write filtered array back to storage

5. **getApplicationsToday(): Promise<TrackedApplication[]>**
   - Read all applications
   - Filter by appliedDate matching today's date (use getTodayDateString() from utils.ts)
   - Return filtered array

Use plain Chrome Storage API (not WXT wrapper) as recommended in research. Import types from `src/types/tracker.ts`. Follow pattern from 04-RESEARCH.md Pattern 1.
  </action>
  <verify>
Run unit tests: `pnpm test src/lib/tracker/storage.test.ts`
All CRUD operations must pass tests (create, read, update, delete scenarios).
Manual check: `pnpm type-check` passes.
  </verify>
  <done>
All 5 storage functions implemented and tested. Applications can be saved, retrieved, updated, and deleted from Chrome Storage. Tests verify CRUD operations work correctly.
  </done>
</task>

<task type="auto">
  <name>Create date and duplicate detection utilities</name>
  <files>src/lib/tracker/utils.ts</files>
  <action>
Implement utility functions for tracker:

1. **getTodayDateString(): string**
   - Get current date in user's local timezone
   - Return YYYY-MM-DD format using `new Date().toLocaleDateString('en-CA')`
   - This ensures calendar day reset at midnight in user's timezone (per CONTEXT.md decision)

2. **isToday(isoDateString: string): boolean**
   - Parse ISO date string
   - Compare date part (YYYY-MM-DD) with getTodayDateString()
   - Return true if same day in user's timezone

3. **normalizeUrl(url: string): string**
   - Remove query parameters (everything after '?')
   - Remove hash fragments (everything after '#')
   - Convert to lowercase
   - Trim trailing slashes
   - Used for duplicate detection (same job URL = duplicate)

4. **isDuplicate(newApp: TrackedApplication, existingApps: TrackedApplication[]): boolean**
   - Normalize both URLs
   - Check if normalized URL exists in existing applications
   - Optionally: check if applied within last 7 days (stricter duplicate detection)
   - Return true if duplicate found

Follow pattern from 04-RESEARCH.md Pattern 4 (calendar day calculations). Export all functions.
  </action>
  <verify>
Run unit tests: `pnpm test src/lib/tracker/utils.test.ts`
Tests must cover: timezone edge cases, URL normalization (with/without query params), duplicate detection scenarios.
  </verify>
  <done>
All 4 utility functions implemented and tested. Date calculations use local timezone. URL normalization handles query params and hashes correctly. Duplicate detection prevents saving same job twice.
  </done>
</task>

</tasks>

<verification>
**Manual verification steps:**

1. TypeScript compilation: `pnpm type-check` passes with no errors
2. Unit tests: `pnpm test src/lib/tracker/` all pass
3. Code inspection: Check that storage.ts uses chrome.storage.local (not sync)
4. Integration check: Import storage functions in a test file and verify CRUD operations work end-to-end

**Expected outcomes:**
- All types properly exported and usable
- Applications can be saved to and retrieved from Chrome Storage
- Date calculations use user's local timezone (not UTC)
- Duplicate detection prevents saving same job URL twice
- All tests pass (100% coverage for critical logic)
</verification>

<success_criteria>
**Phase 4 Plan 01 complete when:**

- [ ] src/types/tracker.ts exists with TrackedApplication, ApplicationStatus, ATSPlatform, VolumeData
- [ ] src/lib/tracker/storage.ts implements all 5 CRUD functions
- [ ] src/lib/tracker/utils.ts implements all 4 utility functions
- [ ] `pnpm type-check` passes with no errors
- [ ] Unit tests pass for storage and utils modules
- [ ] Code review: storage uses chrome.storage.local (not sync)
- [ ] Code review: date functions use toLocaleDateString('en-CA') for timezone awareness
- [ ] Git commit created: `feat(04-01): implement tracker data layer and Chrome Storage operations`
</success_criteria>

<output>
After completion, create `.planning/phases/04-job-tracker-safety/04-01-SUMMARY.md` with:
- Files created (types, storage, utils)
- Key patterns used (Chrome Storage API, timezone-aware dates)
- Test coverage achieved
- Any issues encountered and how resolved
</output>
