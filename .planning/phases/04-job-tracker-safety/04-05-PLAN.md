---
phase: 04-job-tracker-safety
plan: 05
type: execute
wave: 3
depends_on: ["04-01", "04-03"]
files_modified:
  - src/entrypoints/popup/components/VolumeWarning.tsx
  - src/entrypoints/popup/components/SiteDisableToggle.tsx
  - src/lib/safety/site-disable.ts
  - src/entrypoints/popup/App.tsx
  - src/entrypoints/content/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees warning when 15+ applications submitted in one day"
    - "Warning is dismissible and non-blocking (user can continue)"
    - "User can disable extension for specific job URL from popup"
    - "Disabled jobs show in settings with re-enable option"
    - "Autofill and AI features respect per-job disable list"
  artifacts:
    - path: "src/lib/safety/site-disable.ts"
      provides: "Per-job disable list management"
      exports: ["isJobDisabled", "disableJob", "enableJob", "getDisabledJobs"]
      min_lines: 60
    - path: "src/entrypoints/popup/components/VolumeWarning.tsx"
      provides: "Dismissible warning banner for volume guardrail"
      exports: ["VolumeWarning"]
      min_lines: 40
    - path: "src/entrypoints/popup/components/SiteDisableToggle.tsx"
      provides: "Toggle to disable extension for current job"
      exports: ["SiteDisableToggle"]
      min_lines: 60
  key_links:
    - from: "src/entrypoints/popup/components/VolumeWarning.tsx"
      to: "src/lib/safety/volume-limiter.ts"
      via: "shouldShowVolumeWarning() check"
      pattern: "shouldShowVolumeWarning\\(\\)"
    - from: "src/entrypoints/content/index.ts"
      to: "src/lib/safety/site-disable.ts"
      via: "isJobDisabled() check before autofill/AI"
      pattern: "isJobDisabled\\("
---

<objective>
Implement safety controls: volume guardrail warning (soft, non-blocking) and per-job disable toggle with granular control.

**Purpose:** Final safety features to guide user behavior and provide escape hatch for problematic job postings.

**Output:** Warning banner for high application volume and toggle to disable extension per specific job URL.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/kittu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-job-tracker-safety/04-CONTEXT.md
@.planning/phases/04-job-tracker-safety/04-RESEARCH.md
@src/entrypoints/popup/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Create per-job disable list manager</name>
  <files>src/lib/safety/site-disable.ts</files>
  <action>
Implement per-job disable list with Chrome Storage per 04-RESEARCH.md Pattern 5:

1. **Storage key:** 'disabledJobs' (array of URLs)

2. **isJobDisabled(jobUrl: string): Promise<boolean>**
   - Read disabledJobs array from chrome.storage.local
   - Normalize jobUrl using normalizeUrl() from tracker/utils.ts
   - Check if normalized URL exists in array
   - Return true if found, false otherwise

3. **disableJob(jobUrl: string): Promise<void>**
   - Read disabledJobs array
   - Normalize jobUrl
   - If not already in array, push it
   - Save updated array to chrome.storage.local

4. **enableJob(jobUrl: string): Promise<void>**
   - Read disabledJobs array
   - Normalize jobUrl
   - Filter out matching URL
   - Save filtered array to chrome.storage.local

5. **getDisabledJobs(): Promise<string[]>**
   - Read disabledJobs array
   - Return full list (for settings display)

6. **Duration policy (Claude's Discretion from CONTEXT.md):**
   - Choose: Permanent disable until user re-enables (simplest, most common use case)
   - Alternative: Session-only (clears on browser restart) - adds complexity
   - Recommendation: Permanent with easy re-enable from settings

Follow pattern from 04-RESEARCH.md Pattern 5. Use normalizeUrl for consistent URL matching (ignore query params).
  </action>
  <verify>
Run unit tests: `pnpm test src/lib/safety/site-disable.test.ts`
Tests must verify: URL normalization, enable/disable operations, persistence.
Manual check: Disable a job → check chrome.storage.local in DevTools → verify URL stored.
  </verify>
  <done>
Per-job disable list implemented with Chrome Storage. URLs normalized for consistent matching. Permanent disable with manual re-enable (simplest UX).
  </done>
</task>

<task type="auto">
  <name>Build volume warning banner component</name>
  <files>src/entrypoints/popup/components/VolumeWarning.tsx</files>
  <action>
Create dismissible warning banner for volume guardrail per CONTEXT.md (soft warning, non-blocking):

1. **Warning trigger:**
   - Use shouldShowVolumeWarning() from volume-limiter.ts
   - Check on component mount and when applications count changes
   - Show warning if count >= 15 (per Plan 03 threshold)

2. **Warning display (Claude's Discretion from CONTEXT.md):**
   - **Display mechanism:** Inline banner (not modal - less intrusive)
   - **Message tone:** Quality-focused (per CONTEXT.md suggestion)
   - **Message text:** "You've applied to 15+ jobs today. Consider focusing on quality over quantity - tailored applications get better results!"
   - **Style:** Orange/yellow background, warning icon, non-alarming but noticeable

3. **Dismissibility:**
   - "Dismiss" button or "×" close icon
   - On dismiss: store dismissal in localStorage with date key
   - Don't show again for same calendar day (resets at midnight per volume limiter logic)
   - Key: `volumeWarningDismissed-{YYYY-MM-DD}`

4. **Non-blocking behavior:**
   - Warning does NOT disable autofill or AI features
   - User can continue applying without restriction
   - This is a "soft" guardrail per CONTEXT.md decision (warnings only, no hard block)

5. **Placement:**
   - Top of popup (above tracker list or in header area)
   - Sticky or fixed at top so visible while scrolling
   - Minimal height to not obscure content

Use Tailwind for styling. Follow existing banner/alert patterns if any exist in project. Export VolumeWarning component.
  </action>
  <verify>
Manual test:
1. Submit 15 applications in one day (or mock volume count)
2. Open popup → verify warning banner visible
3. Dismiss warning → verify disappears
4. Close and reopen popup → verify warning does not reappear (same day)
5. Mock date to next day → verify warning can appear again if threshold reached
6. Verify autofill still works (warning does not block features)
  </verify>
  <done>
Volume warning banner displays after 15 applications. Dismissible and persists dismissal for calendar day. Non-blocking (autofill/AI still work). Quality-focused message encourages thoughtful applications.
  </done>
</task>

<task type="auto">
  <name>Build per-site disable toggle component</name>
  <files>src/entrypoints/popup/components/SiteDisableToggle.tsx</files>
  <action>
Create toggle to disable extension for current job per CONTEXT.md (popup toggle, per-job granularity):

1. **Current job URL detection:**
   - Use chrome.tabs.query({ active: true, currentWindow: true }) to get active tab
   - Extract URL from tab.url
   - Normalize URL for matching

2. **Toggle state:**
   - Check if current URL is in disabled jobs list: isJobDisabled(currentUrl)
   - Display toggle in enabled or disabled state accordingly

3. **Toggle interaction:**
   - **If currently enabled (extension active on this job):**
     - Toggle shows "Disable on this job" or toggle switch in "on" position
     - On click: call disableJob(currentUrl)
     - Show confirmation toast: "Extension disabled for this job"
   - **If currently disabled:**
     - Toggle shows "Enable on this job" or toggle switch in "off" position
     - On click: call enableJob(currentUrl)
     - Show confirmation toast: "Extension re-enabled for this job"

4. **Visual design:**
   - Toggle switch (checkbox styled as toggle) or button
   - Clear labels: "Extension active on this job" (with on/off toggle)
   - Positioned at top of popup (above tracker or in header)
   - Small, non-intrusive but easily accessible

5. **Settings integration:**
   - Link to settings page: "Manage disabled sites"
   - Settings page shows full list of disabled jobs with re-enable buttons
   - (Settings page enhancement optional - can be follow-up task)

6. **Content script integration:**
   - When toggle state changes, send message to content script
   - Content script checks isJobDisabled() before running autofill or AI features
   - Immediate effect (no page reload required)

Use Tailwind for styling. Follow existing toggle/switch patterns from profile editor if any. Export SiteDisableToggle component.
  </action>
  <verify>
Manual test:
1. Open popup on Workday job page
2. Verify toggle shows "Extension active" or enabled state
3. Toggle to disable → verify toast confirms
4. Try autofill button on page → verify autofill disabled (grayed out or hidden)
5. Open popup again → toggle back to enable → verify autofill works again
6. Check chrome.storage.local → verify URL added/removed from disabledJobs array
  </verify>
  <done>
Per-site disable toggle functional in popup. Disables extension features for specific job URL. Re-enable from toggle or settings. Immediate effect without page reload. Chrome Storage persists disabled jobs list.
  </done>
</task>

<task type="auto">
  <name>Integrate safety controls into popup and content script</name>
  <files>
src/entrypoints/popup/App.tsx
src/entrypoints/content/index.ts
  </files>
  <action>
Integrate volume warning and site disable toggle into existing UI and content script:

**App.tsx (popup):**

1. **Add VolumeWarning component:**
   - Import VolumeWarning
   - Render at top of popup (above tabs or in header)
   - Component handles its own visibility logic (shows if threshold reached + not dismissed)

2. **Add SiteDisableToggle component:**
   - Import SiteDisableToggle
   - Render in header or top of popup (near volume warning)
   - Shows current job's enable/disable state

3. **Layout:**
   - VolumeWarning: full-width banner at very top
   - SiteDisableToggle: in header next to extension icon or tab controls
   - Ensure both fit within popup width (400px)

**index.ts (content script):**

1. **Check disabled status before features:**
   - Before initializing autofill (Phase 2 code):
     - const disabled = await isJobDisabled(window.location.href)
     - If disabled, skip autofill button injection
   - Before initializing AI answer suggestions (Phase 3 code):
     - Same check, skip AI features if disabled

2. **Listen for disable state changes:**
   - chrome.runtime.onMessage listener for 'JOB_DISABLED' or 'JOB_ENABLED' messages
   - On JOB_DISABLED: remove autofill button, disable AI features
   - On JOB_ENABLED: re-initialize features (inject autofill button, activate AI)

3. **Visual feedback:**
   - Optional: When disabled, show small badge or notice: "Extension disabled on this job"
   - Don't interfere with page layout, keep it minimal

Note: Both files have existing code from Phases 1-3. ADD these safety controls, don't replace existing functionality.
  </action>
  <verify>
End-to-end test:
1. Open popup with 14 applications today → no warning visible
2. Submit 1 more application → open popup → verify volume warning appears
3. Navigate to job posting → verify autofill button visible
4. Open popup → disable extension for this job → verify autofill button disappears
5. Open popup on different job → verify autofill still works (disable is per-job)
6. Re-enable disabled job → verify autofill button reappears without page reload
  </verify>
  <done>
Volume warning and site disable toggle integrated into popup. Content script respects disabled jobs list (skips autofill/AI on disabled URLs). Real-time toggle updates without page reload. All safety controls functional.
  </done>
</task>

</tasks>

<verification>
**Manual verification steps:**

1. **Volume warning:**
   - Submit 15 applications (or mock volume count in localStorage)
   - Open popup → verify warning banner visible at top
   - Message should be quality-focused, not alarming
   - Dismiss warning → verify it disappears
   - Close popup, reopen → verify warning stays dismissed
   - Try autofill → verify still works (warning is non-blocking)

2. **Per-job disable:**
   - Navigate to Workday job page
   - Open popup → verify toggle shows "Extension active"
   - Toggle off → verify confirmation toast
   - Verify autofill button disappears or grays out
   - Try AI suggestion button → verify also disabled
   - Open popup → toggle back on → verify features reappear
   - Navigate to different Workday job → verify autofill works (disable was job-specific)

3. **Persistence:**
   - Disable job, close browser, reopen
   - Navigate to same job → verify still disabled
   - Check chrome.storage.local in DevTools → verify URL in disabledJobs array

4. **Edge cases:**
   - Disable job with query params: mysite.com/job?id=123
   - Navigate to same job with different params: mysite.com/job?id=123&ref=email
   - Verify still disabled (normalizeUrl removes query params)
   - Re-enable, verify enables for all param variations

**Expected outcomes:**
- Volume warning appears at 15 apps, is dismissible, doesn't block features
- Per-job disable toggle works instantly without page reload
- Disabled jobs persist across browser restarts
- URL normalization handles query params correctly
- No interference with autofill/AI when extension enabled
- Settings page shows disabled jobs list (if implemented)
</verification>

<success_criteria>
**Phase 4 Plan 05 complete when:**

- [ ] src/lib/safety/site-disable.ts implements per-job disable list
- [ ] VolumeWarning component displays after 15 applications
- [ ] Volume warning is dismissible and non-blocking
- [ ] SiteDisableToggle component works in popup
- [ ] Disable toggle prevents autofill and AI on specific job
- [ ] Re-enable toggle restores features without page reload
- [ ] Disabled jobs persist in Chrome Storage
- [ ] URL normalization handles query params correctly
- [ ] Manual testing confirms all safety controls work end-to-end
- [ ] Unit tests pass for site-disable.ts
- [ ] No regression: existing features (autofill, AI, tracker) still work
- [ ] Git commit created: `feat(04-05): implement volume warning and per-job disable controls`
</success_criteria>

<output>
After completion, create `.planning/phases/04-job-tracker-safety/04-05-SUMMARY.md` with:
- Volume warning UX decisions (message tone, display mechanism, dismissal behavior)
- Per-job disable implementation (URL normalization, persistence, real-time updates)
- Integration with existing features (autofill, AI)
- Settings page design (if implemented)
- Test results from manual verification
- Any edge cases discovered and how handled
</output>
