---
phase: 04-job-tracker-safety
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/safety/captcha-detector.ts
  - src/entrypoints/background.ts
  - src/entrypoints/content/captcha.ts
autonomous: true

must_haves:
  truths:
    - "CAPTCHA presence is detected on ATS pages"
    - "Extension badge shows warning when CAPTCHA detected"
    - "Badge clears when CAPTCHA is solved"
    - "Detection works for reCAPTCHA v2, hCaptcha, Cloudflare Turnstile"
  artifacts:
    - path: "src/lib/safety/captcha-detector.ts"
      provides: "CAPTCHA detection logic using DOM selectors"
      exports: ["isCaptchaPresent", "CAPTCHA_SELECTORS"]
      min_lines: 60
    - path: "src/entrypoints/content/captcha.ts"
      provides: "Content script for CAPTCHA monitoring"
      exports: []
      min_lines: 40
    - path: "src/entrypoints/background.ts"
      provides: "Badge update handler for CAPTCHA state"
      contains: "chrome.action.setBadgeText"
      min_lines: 30
  key_links:
    - from: "src/entrypoints/content/captcha.ts"
      to: "src/lib/safety/captcha-detector.ts"
      via: "isCaptchaPresent() function call"
      pattern: "isCaptchaPresent\\(\\)"
    - from: "src/entrypoints/content/captcha.ts"
      to: "chrome.runtime.sendMessage"
      via: "CAPTCHA_DETECTED / CAPTCHA_CLEARED messages"
      pattern: "chrome\\.runtime\\.sendMessage.*CAPTCHA"
    - from: "src/entrypoints/background.ts"
      to: "chrome.action.setBadgeText"
      via: "Badge update on CAPTCHA state change"
      pattern: "setBadgeText"
---

<objective>
Implement CAPTCHA detection system that monitors ATS pages for challenge presence and updates extension badge to notify users.

**Purpose:** Safety control to prevent extension behavior during CAPTCHA challenges, avoiding platform detection and potential bans.

**Output:** DOM-based multi-provider CAPTCHA detector with real-time monitoring and badge notification system.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/kittu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-job-tracker-safety/04-CONTEXT.md
@.planning/phases/04-job-tracker-safety/04-RESEARCH.md
@src/entrypoints/content/index.ts
</context>

<tasks>

<task type="auto">
  <name>Create CAPTCHA detection module</name>
  <files>src/lib/safety/captcha-detector.ts</files>
  <action>
Implement DOM-based CAPTCHA detection for multiple providers:

1. **CAPTCHA_SELECTORS constant array** with selectors for:
   - reCAPTCHA v2: 'iframe[src*="google.com/recaptcha"]', '.g-recaptcha'
   - reCAPTCHA v3: 'script[src*="google.com/recaptcha/api.js"]'
   - hCaptcha: 'iframe[src*="hcaptcha.com"]', '.h-captcha'
   - Cloudflare Turnstile: 'iframe[src*="challenges.cloudflare.com"]', '.cf-turnstile'

2. **isCaptchaPresent(): boolean**
   - Query document for each selector in CAPTCHA_SELECTORS
   - For each found element, check if visible (not display:none, visibility:hidden, or opacity:0)
   - Use window.getComputedStyle() to check visibility
   - Return true if any visible CAPTCHA element found
   - Return false if none found or all hidden

3. **getCaptchaType(): string | null**
   - Identify which CAPTCHA provider is present
   - Return 'recaptcha', 'hcaptcha', 'turnstile', or null
   - Useful for analytics/debugging

Export isCaptchaPresent as primary function, CAPTCHA_SELECTORS for testing. Follow pattern from 04-RESEARCH.md Pattern 3.
  </action>
  <verify>
Run unit tests: `pnpm test src/lib/safety/captcha-detector.test.ts`
Tests must cover: element presence, visibility checks, multi-provider detection.
Manual check: `pnpm type-check` passes.
  </verify>
  <done>
CAPTCHA detection module implemented with selectors for all major providers. Visibility checks prevent false positives from hidden elements. Tests verify detection logic.
  </done>
</task>

<task type="auto">
  <name>Create CAPTCHA monitoring content script</name>
  <files>src/entrypoints/content/captcha.ts</files>
  <action>
Implement content script that monitors for CAPTCHA appearance/disappearance:

1. **Initial CAPTCHA check on page load**
   - Call isCaptchaPresent() from captcha-detector.ts
   - Send message to background script with initial state

2. **MutationObserver setup**
   - Observe document.body for changes (childList, subtree, attributes)
   - Debounce checks to every 500ms to avoid excessive CPU usage
   - On each mutation batch, call isCaptchaPresent()
   - Track previous state to avoid redundant messages

3. **Message sending to background**
   - When CAPTCHA detected (state changes from false to true):
     - Send `{ type: 'CAPTCHA_DETECTED', url: window.location.href }`
   - When CAPTCHA cleared (state changes from true to false):
     - Send `{ type: 'CAPTCHA_CLEARED', url: window.location.href }`

4. **Integration with autofill**
   - Export `isCaptchaBlocking(): boolean` function
   - This will be checked before any autofill operation (in Phase 3 integration)

Follow pattern from 04-RESEARCH.md Pattern 3. Use MutationObserver with debouncing to prevent performance issues. Only send messages on state change (not continuously).
  </action>
  <verify>
Manual test on page with reCAPTCHA iframe (e.g., demo page)
Check browser console for CAPTCHA_DETECTED message sent to background
Verify MutationObserver doesn't cause performance issues (check DevTools Performance tab)
  </verify>
  <done>
Content script monitors for CAPTCHA appearance using MutationObserver. Messages sent to background script on state changes. Debouncing prevents excessive checks.
  </done>
</task>

<task type="auto">
  <name>Implement badge update in background script</name>
  <files>src/entrypoints/background.ts</files>
  <action>
Add CAPTCHA badge notification to background service worker:

1. **Message listener for CAPTCHA state**
   - Listen for messages with type 'CAPTCHA_DETECTED' and 'CAPTCHA_CLEARED'
   - Extract sender.tab.id to target correct tab

2. **CAPTCHA_DETECTED handler**
   - Call chrome.action.setBadgeText({ text: '⚠️', tabId: sender.tab?.id })
   - Call chrome.action.setBadgeBackgroundColor({ color: '#FFA500' }) (orange)
   - Badge remains visible until CAPTCHA cleared (per CONTEXT.md decision)

3. **CAPTCHA_CLEARED handler**
   - Call chrome.action.setBadgeText({ text: '', tabId: sender.tab?.id })
   - Removes badge from extension icon

4. **Error handling**
   - Wrap badge API calls in try-catch (badge API can fail if tab closed)
   - Log errors but don't crash background script

Follow pattern from 04-RESEARCH.md Extension Badge Update example. Use chrome.action API (MV3, not deprecated chrome.browserAction).

Note: Existing background.ts may have other logic from Phase 3. ADD this functionality, don't replace existing code.
  </action>
  <verify>
Manual test: Open page with CAPTCHA → verify orange badge appears on extension icon
Complete CAPTCHA → verify badge disappears
Check that badge is tab-specific (doesn't show on tabs without CAPTCHA)
  </verify>
  <done>
Background script updates badge based on CAPTCHA state messages from content script. Badge shows orange warning when CAPTCHA detected, clears when solved. Tab-specific badge targeting works correctly.
  </done>
</task>

</tasks>

<verification>
**Manual verification steps:**

1. **Test reCAPTCHA detection:**
   - Visit page with reCAPTCHA v2 challenge
   - Verify extension badge shows orange "⚠️"
   - Complete CAPTCHA
   - Verify badge clears

2. **Test hCaptcha detection:**
   - Visit page with hCaptcha
   - Verify same badge behavior

3. **Test false positive prevention:**
   - Visit page without CAPTCHA
   - Verify no badge appears
   - Visit page with hidden CAPTCHA element (display:none)
   - Verify no badge appears (visibility check working)

4. **Test performance:**
   - Open DevTools Performance tab
   - Record page with CAPTCHA
   - Verify MutationObserver doesn't cause excessive CPU usage
   - Check that debouncing limits checks to ~2/second max

5. **Test multi-tab behavior:**
   - Open 2 tabs: one with CAPTCHA, one without
   - Verify badge only appears on tab with CAPTCHA (tab-specific)

**Expected outcomes:**
- CAPTCHA detection works for reCAPTCHA v2/v3, hCaptcha, Turnstile
- Badge appears promptly when CAPTCHA loads (within 500ms)
- Badge clears when CAPTCHA solved
- No false positives on pages without CAPTCHA
- Performance impact minimal (<1% CPU when idle)
</verification>

<success_criteria>
**Phase 4 Plan 02 complete when:**

- [ ] src/lib/safety/captcha-detector.ts implements isCaptchaPresent() with multi-provider selectors
- [ ] src/entrypoints/content/captcha.ts implements MutationObserver monitoring
- [ ] src/entrypoints/background.ts handles CAPTCHA_DETECTED/CAPTCHA_CLEARED messages
- [ ] Extension badge shows orange "⚠️" when CAPTCHA detected
- [ ] Badge clears when CAPTCHA solved
- [ ] Manual testing confirms detection works for reCAPTCHA v2, hCaptcha, Turnstile
- [ ] No false positives on pages without CAPTCHA
- [ ] MutationObserver performance is acceptable (<1% CPU idle)
- [ ] Unit tests pass for captcha-detector.ts
- [ ] Git commit created: `feat(04-02): implement CAPTCHA detection and badge notification`
</success_criteria>

<output>
After completion, create `.planning/phases/04-job-tracker-safety/04-02-SUMMARY.md` with:
- CAPTCHA providers supported (selectors used)
- Detection approach (MutationObserver with debouncing)
- Badge notification behavior
- Performance impact measured
- Any edge cases discovered during testing
</output>
