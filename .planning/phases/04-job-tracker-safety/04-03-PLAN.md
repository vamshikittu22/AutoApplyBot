---
phase: 04-job-tracker-safety
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/entrypoints/content/submission-logger.ts
  - src/lib/safety/volume-limiter.ts
  - src/entrypoints/content/index.ts
autonomous: true

must_haves:
  truths:
    - "Applications are automatically logged after successful form submission"
    - "No logging occurs when CAPTCHA is present"
    - "Duplicate submissions within 7 days trigger warning (but still log if user confirms)"
    - "Volume count increments each day and resets at midnight local time"
  artifacts:
    - path: "src/entrypoints/content/submission-logger.ts"
      provides: "Hybrid submission detection and automatic logging"
      exports: ["initSubmissionLogger"]
      min_lines: 100
    - path: "src/lib/safety/volume-limiter.ts"
      provides: "Volume tracking and calendar day reset logic"
      exports: ["getVolume Data", "incrementVolume", "shouldShowVolumeWarning"]
      min_lines: 60
    - path: "src/entrypoints/content/index.ts"
      provides: "Content script entry point with submission logger initialization"
      contains: "initSubmissionLogger"
  key_links:
    - from: "src/entrypoints/content/submission-logger.ts"
      to: "src/lib/tracker/storage.ts"
      via: "saveApplication() call after submission detected"
      pattern: "saveApplication\\("
    - from: "src/entrypoints/content/submission-logger.ts"
      to: "src/entrypoints/content/captcha.ts"
      via: "isCaptchaBlocking() check before logging"
      pattern: "isCaptchaBlocking\\(\\)"
    - from: "src/entrypoints/content/submission-logger.ts"
      to: "src/lib/safety/volume-limiter.ts"
      via: "incrementVolume() call after successful log"
      pattern: "incrementVolume\\(\\)"
---

<objective>
Implement automatic application logging using hybrid submission detection (form events + URL change monitoring) with safety checks (CAPTCHA blocking, duplicate detection, volume tracking).

**Purpose:** Core tracker functionality - automatically capture application submissions without manual user input.

**Output:** Content script that reliably detects form submissions, extracts job metadata, and logs to Chrome Storage with volume tracking.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/kittu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-job-tracker-safety/04-CONTEXT.md
@.planning/phases/04-job-tracker-safety/04-RESEARCH.md
@src/lib/ats/detection.ts
@src/entrypoints/content/index.ts
@.planning/phases/02-ats-detection-autofill/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create volume limiter with calendar day reset</name>
  <files>src/lib/safety/volume-limiter.ts</files>
  <action>
Implement volume tracking with calendar day reset per CONTEXT.md decision (not rolling 24h window):

1. **VolumeData interface** (import from src/types/tracker.ts):
   - date: string (YYYY-MM-DD in user timezone)
   - count: number

2. **getVolumeData(): Promise<VolumeData>**
   - Read from chrome.storage.local.get('volumeData')
   - Check if volumeData.date matches getTodayDateString() (from utils.ts)
   - If date changed (new day), reset count to 0 and update date
   - Return current VolumeData

3. **incrementVolume(): Promise<void>**
   - Get current VolumeData
   - Increment count by 1
   - Update date to today (defensive, in case called at midnight)
   - Save to chrome.storage.local.set({ volumeData })

4. **shouldShowVolumeWarning(): Promise<boolean>**
   - Get current VolumeData
   - Return true if count >= 15 (per CONTEXT.md: warning at 15 apps/day, soft warning only)
   - Note: Original requirement said 30 apps/24h, but CONTEXT.md clarified 15 for soft warning

5. **resetVolume(): Promise<void>**
   - Set volumeData to { date: getTodayDateString(), count: 0 }
   - Used for testing or user-triggered reset

Follow pattern from 04-RESEARCH.md Pattern 4. Use getTodayDateString() from src/lib/tracker/utils.ts to ensure timezone-aware calendar day calculation.
  </action>
  <verify>
Run unit tests: `pnpm test src/lib/safety/volume-limiter.test.ts`
Tests must verify: calendar day reset at midnight, timezone handling, increment logic.
Mock Date to test midnight rollover behavior.
  </verify>
  <done>
Volume limiter implemented with calendar day reset. Tests confirm count resets at midnight in user's local timezone. Warning threshold set at 15 applications/day.
  </done>
</task>

<task type="auto">
  <name>Implement hybrid submission detection and logging</name>
  <files>src/entrypoints/content/submission-logger.ts</files>
  <action>
Create submission detection system combining form submit events + URL change monitoring per 04-RESEARCH.md Pattern 2:

1. **extractJobMetadata(): TrackedApplication**
   - Use existing ATS detection from Phase 2 (import from src/lib/ats/detection.ts)
   - Extract job title from page:
     - Workday: h1, h2 with job title patterns
     - Greenhouse: .app-title, h1.app-title
     - Lever: .posting-headline h2
   - Extract company name from page:
     - Workday: data-automation-id attributes
     - Greenhouse: .company-name
     - Lever: .main-footer .company-name
   - Fallback: use document.title or prompt user (future enhancement)
   - Generate UUID using crypto.randomUUID()
   - Return TrackedApplication object with status: 'applied', appliedDate: new Date().toISOString()

2. **Form submit event listener**
   - Attach to document for event delegation
   - On submit event (event.target is HTMLFormElement):
     - Check if CAPTCHA present: call isCaptchaBlocking() from captcha.ts
     - If CAPTCHA present, abort logging (return early)
     - Extract job metadata
     - Check for duplicates: call isDuplicate() from utils.ts
     - Store pending submission in chrome.storage.session: { pendingSubmission: metadata, timestamp: Date.now() }
     - Note: Don't log immediately - wait for navigation confirmation (URL change or network success)

3. **URL change monitoring**
   - Use MutationObserver on document.querySelector('title') to detect navigation
   - Debounce 300ms to avoid multiple triggers
   - On URL change:
     - Check for success patterns: /\/(submitted|thank-you|confirmation|success|application-received)/i.test(window.location.href)
     - If success pattern found:
       - Retrieve pendingSubmission from session storage
       - If exists and timestamp < 10s old (prevent stale submissions):
         - Call saveApplication() from storage.ts
         - Call incrementVolume() from volume-limiter.ts
         - Clear pendingSubmission from session
         - Log success to console (for debugging)

4. **Edge case handling**
   - Timeout: If pendingSubmission sits in session for >10 seconds, discard (likely user abandoned)
   - AJAX submissions: Detect by monitoring fetch/XHR (optional enhancement, focus on URL change first)
   - False positives: Only log if both submit event fired AND success URL pattern matched

5. **Error handling**
   - Wrap all Chrome Storage calls in try-catch
   - If saveApplication fails, show console warning but don't crash
   - If CAPTCHA check fails (undefined), assume CAPTCHA present (fail safe)

Export initSubmissionLogger() function that sets up all listeners. Follow pattern from 04-RESEARCH.md Pattern 2 (hybrid approach).
  </action>
  <verify>
Manual testing required:
1. Apply to Workday job → verify logged in tracker
2. Apply to Greenhouse job → verify logged
3. Apply to job with CAPTCHA present → verify NOT logged
4. Apply to same job twice within 1 minute → verify duplicate detection (should still log but with warning)
5. Check chrome.storage.local in DevTools → verify volume count incremented

Run unit tests: `pnpm test src/entrypoints/content/submission-logger.test.ts` for metadata extraction logic.
  </verify>
  <done>
Hybrid submission detection implemented. Applications logged automatically after successful submission (submit event + URL success pattern). CAPTCHA check prevents logging during challenges. Volume increments on each successful log.
  </done>
</task>

<task type="auto">
  <name>Integrate submission logger into content script entry point</name>
  <files>src/entrypoints/content/index.ts</files>
  <action>
Integrate submission logger into existing content script (Phase 2/3):

1. **Import initSubmissionLogger** from ./submission-logger.ts

2. **Call initSubmissionLogger()** in main content script initialization
   - Place after ATS detection setup (from Phase 2)
   - Before autofill button injection (so logging is ready when user autofills)

3. **Conditional initialization**
   - Only initialize if ATS detected OR page has forms (don't run on every page)
   - Check: `document.querySelector('form')` exists
   - This prevents unnecessary listener setup on non-application pages

4. **Error boundary**
   - Wrap initSubmissionLogger() in try-catch
   - If initialization fails, log error but don't crash entire content script
   - Other features (autofill, AI) should continue working even if submission logging fails

Note: Existing content script already has autofill and AI answer generation from Phase 2/3. ADD submission logging, don't replace existing functionality.
  </action>
  <verify>
Manual test: Open Workday/Greenhouse/Lever job page → verify no console errors
Check that submission logger initializes only on pages with forms
Verify autofill and AI features still work (no regression)
  </verify>
  <done>
Submission logger integrated into content script entry point. Initializes on pages with forms, doesn't interfere with existing autofill/AI features.
  </done>
</task>

</tasks>

<verification>
**End-to-end test scenarios:**

1. **Happy path (Workday):**
   - Find real Workday job posting
   - Fill out application manually (or use autofill from Phase 2)
   - Click Submit button
   - Verify redirected to confirmation page
   - Check tracker: application should be logged with correct company, job title, date, status=applied
   - Check volume: count should be 1 (or incremented)

2. **CAPTCHA blocking:**
   - Find page with reCAPTCHA
   - Submit form
   - Verify application NOT logged
   - Complete CAPTCHA, resubmit
   - Verify application now logged

3. **Duplicate detection:**
   - Apply to job
   - Immediately apply to same job URL again
   - Verify console shows duplicate warning
   - Verify both submissions logged (no hard block per CONTEXT.md)

4. **Volume tracking:**
   - Log 15 applications in one day
   - Check volume warning flag: shouldShowVolumeWarning() returns true
   - Wait until midnight (or mock getTodayDateString() to next day)
   - Check volume reset: count should be 0

5. **Calendar day reset:**
   - Log application today
   - Mock date to tomorrow (update getTodayDateString return value)
   - Verify volume count resets to 0

**Expected outcomes:**
- Applications logged reliably on Workday, Greenhouse, Lever
- No logging during CAPTCHA challenges
- Volume increments correctly
- Calendar day reset at midnight local time
- No false positives (logging on non-application pages)
</verification>

<success_criteria>
**Phase 4 Plan 03 complete when:**

- [ ] src/lib/safety/volume-limiter.ts implements volume tracking with calendar day reset
- [ ] src/entrypoints/content/submission-logger.ts implements hybrid submission detection
- [ ] Applications automatically logged after successful form submission
- [ ] CAPTCHA presence blocks logging
- [ ] Volume count increments on each submission
- [ ] Volume resets at midnight in user's local timezone
- [ ] Manual testing confirms logging works on Workday, Greenhouse, Lever
- [ ] Unit tests pass for volume-limiter and submission-logger
- [ ] No regression: autofill and AI features still work
- [ ] Git commit created: `feat(04-03): implement automatic submission logging with volume tracking`
</success_criteria>

<output>
After completion, create `.planning/phases/04-job-tracker-safety/04-03-SUMMARY.md` with:
- Submission detection approach (hybrid: events + URL monitoring)
- Job metadata extraction patterns per ATS
- Volume tracking behavior (threshold, reset logic)
- Edge cases handled (duplicates, CAPTCHA, timeouts)
- Test results from manual E2E testing
</output>
