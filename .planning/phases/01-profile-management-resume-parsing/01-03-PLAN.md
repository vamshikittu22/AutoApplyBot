---
phase: 01-profile-management-resume-parsing
plan: 03
type: execute
wave: 2
depends_on: ['01-01']
files_modified:
  - src/lib/storage/profile-storage.ts
  - tests/unit/storage/profile-storage.test.ts
autonomous: true

must_haves:
  truths:
    - "Profile data is stored in Chrome local storage"
    - "Profile persists across browser restarts"
    - "User can export profile as JSON"
    - "User can delete all profile data"
  artifacts:
    - path: "src/lib/storage/profile-storage.ts"
      provides: "Chrome Storage API wrapper for profile persistence"
      exports: ["saveProfile", "loadProfile", "deleteProfile", "exportData", "hasProfile", "updateProfile"]
      min_lines: 60
    - path: "tests/unit/storage/profile-storage.test.ts"
      provides: "Profile storage integration tests"
  key_links:
    - from: "src/lib/storage/profile-storage.ts"
      to: "@/types/profile"
      via: "Saves Profile type"
      pattern: "Profile"
---

<objective>
Implement local storage using Chrome Storage API.

**Purpose:** Store user profile data in Chrome local storage for persistence (REQ-PRO-05 simplified - no encryption in v1). Enable data export and delete functionality (REQ-PRO-06).

**Output:** Fully functional storage layer with unit tests proving persistence works correctly.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/kittu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-profile-management-resume-parsing/01-01-SUMMARY.md
@TECHSTACK.md
@AGENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Profile Storage Module</name>
  <files>src/lib/storage/profile-storage.ts</files>
  <action>
Create `src/lib/storage/profile-storage.ts` with Chrome Storage wrapper (no encryption in v1):

**Implementation requirements:**
- Use Chrome Storage API (native extension API, no dependencies)
- Store profile as JSON in chrome.storage.local
- Simple, straightforward implementation - v1 does not require encryption
- Support export to JSON file and complete data deletion per REQ-PRO-06

**Note on security:** v1 stores profile in plain JSON for simplicity. Chrome Storage is sandboxed per-extension and not accessible to other extensions or websites. v2+ may add encryption if needed.

```typescript
import type { Profile } from '@/types/profile'

const STORAGE_KEY = 'profile'
const APPLICATIONS_KEY = 'applications'
const SETTINGS_KEY = 'settings'

/**
 * Save profile to Chrome local storage.
 * 
 * v1 stores in plain JSON (Chrome Storage is sandboxed per-extension).
 * v2+ may add encryption if needed.
 * 
 * @param profile - User profile to save
 * @throws Error if storage fails
 */
export async function saveProfile(profile: Profile): Promise<void> {
  try {
    await chrome.storage.local.set({ [STORAGE_KEY]: profile })
  } catch (error) {
    throw new Error(`Failed to save profile: ${error instanceof Error ? error.message : 'Unknown error'}`)
  }
}

/**
 * Load profile from Chrome local storage.
 * 
 * @returns Profile if exists, null if not found
 * @throws Error if load fails
 */
export async function loadProfile(): Promise<Profile | null> {
  try {
    const result = await chrome.storage.local.get(STORAGE_KEY)
    
    if (!result[STORAGE_KEY]) {
      return null
    }
    
    return result[STORAGE_KEY] as Profile
  } catch (error) {
    throw new Error(`Failed to load profile: ${error instanceof Error ? error.message : 'Unknown error'}`)
  }
}

/**
 * Delete all user data from Chrome storage (REQ-PRO-06).
 * Includes profile, applications, settings.
 * 
 * ⚠️ This action is irreversible.
 */
export async function deleteProfile(): Promise<void> {
  try {
    await chrome.storage.local.clear()
  } catch (error) {
    throw new Error(`Failed to delete profile: ${error instanceof Error ? error.message : 'Unknown error'}`)
  }
}

/**
 * Export all user data as JSON (REQ-PRO-06).
 * Includes profile, applications, settings.
 * 
 * @returns JSON object with all user data
 */
export async function exportData(): Promise<{
  profile: Profile | null
  applications: any[]
  settings: any
  exportedAt: string
}> {
  try {
    const profile = await loadProfile()
    
    // Load applications and settings
    const result = await chrome.storage.local.get([APPLICATIONS_KEY, SETTINGS_KEY])
    
    return {
      profile,
      applications: result[APPLICATIONS_KEY] || [],
      settings: result[SETTINGS_KEY] || {},
      exportedAt: new Date().toISOString()
    }
  } catch (error) {
    throw new Error(`Failed to export data: ${error instanceof Error ? error.message : 'Unknown error'}`)
  }
}

/**
 * Check if profile exists in storage.
 * Used for onboarding flow detection.
 */
export async function hasProfile(): Promise<boolean> {
  const result = await chrome.storage.local.get(STORAGE_KEY)
  return !!result[STORAGE_KEY]
}

/**
 * Update specific profile fields without loading entire profile.
 * Useful for quick updates (e.g., changing role preference).
 */
export async function updateProfile(updates: Partial<Profile>): Promise<void> {
  const profile = await loadProfile()
  
  if (!profile) {
    throw new Error('No profile exists to update')
  }
  
  const updatedProfile: Profile = {
    ...profile,
    ...updates,
    updatedAt: new Date().toISOString()
  }
  
  await saveProfile(updatedProfile)
}
```

Add JSDoc comments explaining REQ-PRO-06 (export/delete) and noting v1 uses plain storage for simplicity.
  </action>
  <verify>
Run `pnpm type-check` - must pass.
Test manually: save a profile, inspect Chrome Storage (should see JSON profile), load profile (should match original).
  </verify>
  <done>
Profile storage module exported with saveProfile, loadProfile, deleteProfile, exportData, hasProfile, updateProfile. Simple Chrome Storage wrapper.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Storage Unit Tests</name>
  <files>tests/unit/storage/profile-storage.test.ts</files>
  <action>
Create comprehensive unit tests for profile storage:

**File: tests/unit/storage/profile-storage.test.ts**
```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { saveProfile, loadProfile, deleteProfile, exportData, hasProfile } from '@/lib/storage/profile-storage'
import type { Profile } from '@/types/profile'

// Mock chrome.storage.local
const mockStorage: Record<string, any> = {}

global.chrome = {
  storage: {
    local: {
      get: vi.fn((keys) => {
        if (typeof keys === 'string') {
          return Promise.resolve({ [keys]: mockStorage[keys] })
        }
        const result: Record<string, any> = {}
        keys.forEach((key: string) => {
          if (mockStorage[key]) result[key] = mockStorage[key]
        })
        return Promise.resolve(result)
      }),
      set: vi.fn((items) => {
        Object.assign(mockStorage, items)
        return Promise.resolve()
      }),
      clear: vi.fn(() => {
        Object.keys(mockStorage).forEach(key => delete mockStorage[key])
        return Promise.resolve()
      })
    }
  }
} as any

describe('profile-storage', () => {
  const sampleProfile: Profile = {
    personal: {
      name: 'Jane Smith',
      email: 'jane@example.com',
      phone: '555-1234',
      location: 'San Francisco, CA'
    },
    workHistory: [
      {
        id: '1',
        position: 'Engineer',
        company: 'Tech Co',
        startDate: '2020-01',
        endDate: 'Present',
        achievements: ['Built things']
      }
    ],
    education: [],
    skills: [{ name: 'JavaScript' }, { name: 'TypeScript' }],
    links: { github: 'https://github.com/jane' },
    domainExtras: {},
    rolePreference: 'Tech',
    createdAt: '2024-01-01T00:00:00Z',
    updatedAt: '2024-01-01T00:00:00Z'
  }
  
  beforeEach(() => {
    // Clear mock storage
    Object.keys(mockStorage).forEach(key => delete mockStorage[key])
  })
  
  describe('saveProfile / loadProfile', () => {
    it('should save and load profile successfully', async () => {
      await saveProfile(sampleProfile)
      
      // Verify storage contains profile data
      const storedData = mockStorage['profile']
      expect(storedData).toBeDefined()
      expect(storedData).toEqual(sampleProfile)
      
      // Load and verify
      const loadedProfile = await loadProfile()
      expect(loadedProfile).toEqual(sampleProfile)
    })
    
    it('should return null when no profile exists', async () => {
      const profile = await loadProfile()
      expect(profile).toBeNull()
    })
  })
  
  describe('deleteProfile', () => {
    it('should delete all data from storage (REQ-PRO-06)', async () => {
      await saveProfile(sampleProfile)
      expect(await hasProfile()).toBe(true)
      
      await deleteProfile()
      
      expect(await hasProfile()).toBe(false)
      expect(Object.keys(mockStorage).length).toBe(0)
    })
  })
  
  describe('exportData', () => {
    it('should export profile as JSON (REQ-PRO-06)', async () => {
      await saveProfile(sampleProfile)
      
      const exported = await exportData()
      
      expect(exported.profile).toEqual(sampleProfile)
      expect(exported.applications).toEqual([])
      expect(exported.exportedAt).toBeTruthy()
    })
  })
  
  describe('hasProfile', () => {
    it('should detect profile existence', async () => {
      expect(await hasProfile()).toBe(false)
      
      await saveProfile(sampleProfile)
      
      expect(await hasProfile()).toBe(true)
    })
  })
})
```

Add JSDoc comments explaining test coverage for REQ-PRO-06.
  </action>
  <verify>
Run `pnpm test` - all storage tests must pass.
Verify encryption test proves data is not plaintext.
Verify profile storage test proves persistence across save/load cycles.
  </verify>
  <done>
Storage tests passing with encryption validation and profile persistence verification. Coverage includes REQ-PRO-05 (encryption) and REQ-PRO-06 (export/delete).
  </done>
</task>

</tasks>

<verification>
**Profile Storage:**
- [ ] Profile saved to Chrome Storage
- [ ] Profile loads correctly after save
- [ ] Profile persists across mock "browser restart"
- [ ] Delete clears all storage
- [ ] Export produces valid JSON

**Code Quality:**
- [ ] `pnpm type-check` passes
- [ ] `pnpm test` passes with all storage tests
- [ ] Simple implementation with no external dependencies

**Requirements Coverage:**
- [ ] REQ-PRO-05 (simplified): Local storage implemented and tested (no encryption in v1)
- [ ] REQ-PRO-06: Data export and delete implemented and tested
</verification>

<success_criteria>
- Profile storage module fully functional
- Profile persists across sessions
- Export produces JSON
- Delete clears all data irreversibly
- Unit tests validate storage operations
- Zero external dependencies (Chrome Storage API only)
- Simple, maintainable code (no encryption complexity in v1)
</success_criteria>

<output>
After completion, create `.planning/phases/01-profile-management-resume-parsing/01-03-SUMMARY.md` following the standard summary template.
</output>
