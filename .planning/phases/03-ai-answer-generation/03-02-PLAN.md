# Plan 03-02: Mock AI Provider & Prompt Builder

**Phase:** 3 - AI Answer Generation
**Wave:** 2
**Priority:** P0 (Must-Have)
**Estimated Duration:** 45 minutes

---

## Goal

Implement the mock AI provider that generates template-based answers without API calls, and build the prompt engineering system that all providers will use. Mock provider enables development/testing without API keys and provides fallback for users who don't configure real AI.

---

## Context

From CONTEXT.md:
- Three tone variants: Professional (neutral/polished), Concise (minimal but complete), Story-Driven (narrative)
- Essay detection: Character limit ≥500 chars triggers STAR outline
- STAR outline: Full outline with guidance (Situation/Task/Action/Result with explanatory text, placeholders, tips)

From RESEARCH.md:
- Mock provider must produce believably varied responses
- Use question text to customize templates
- Include role-specific vocabulary
- Make placeholders obvious with brackets
- Provide 3 genuinely different template structures

---

## Requirements Covered

- REQ-AI-01: Mock AI response system (complete)
- REQ-AI-03: Role-specific AI tuning (mock implementation)
- REQ-AI-04: Placeholder markers (implementation)
- REQ-AI-05: Essay question handling (STAR outline)

---

## Tasks

### Task 1: Create Prompt Builder
**File:** `src/lib/ai/prompt-builder.ts`
**Action:** Centralized prompt construction logic

```typescript
import type { ToneVariant, RoleType } from '@/types/ai'

export class PromptBuilder {
  /**
   * Build system prompt for AI providers
   */
  static buildSystemPrompt(params: {
    role: RoleType
    tone: ToneVariant
    essayMode: boolean
  }): string {
    const roleContext = this.getRoleContext(params.role)
    const toneInstructions = this.getToneInstructions(params.tone)
    const formatInstructions = params.essayMode 
      ? this.getEssayInstructions() 
      : this.getShortAnswerInstructions()
    
    return `${roleContext}

${toneInstructions}

${formatInstructions}

CRITICAL REQUIREMENTS:
- ALWAYS include placeholders in [brackets] for specific details the user must fill
- NEVER invent specific metrics, dates, company names, or project names
- Make it obvious what needs user input
- Keep placeholders descriptive: [specific project name] not [project]
- Examples of good placeholders: [X% improvement], [Y years], [Z technology]`
  }
  
  /**
   * Build user prompt with question context
   */
  static buildUserPrompt(params: {
    question: string
    questionContext?: string
  }): string {
    let prompt = `Answer this job application question:\n\n"${params.question}"`
    
    if (params.questionContext) {
      prompt += `\n\nContext: ${params.questionContext}`
    }
    
    return prompt
  }
  
  /**
   * Build prompt variants for multiple drafts
   */
  static buildPromptVariants(params: {
    question: string
    questionContext?: string
    tone: ToneVariant
  }): string[] {
    const basePrompt = this.buildUserPrompt(params)
    
    // Create 3 variations by adding emphasis instructions
    const variations = {
      professional: [
        `${basePrompt}\n\nEmphasize: Professional achievements and quantifiable results.`,
        `${basePrompt}\n\nEmphasize: Collaborative skills and team impact.`,
        `${basePrompt}\n\nEmphasize: Problem-solving approach and methodology.`
      ],
      concise: [
        `${basePrompt}\n\nBe extremely concise. Focus on the most important point.`,
        `${basePrompt}\n\nBe extremely concise. Focus on measurable outcomes.`,
        `${basePrompt}\n\nBe extremely concise. Focus on relevant skills.`
      ],
      'story-driven': [
        `${basePrompt}\n\nTell a compelling story with a clear challenge and resolution.`,
        `${basePrompt}\n\nTell a story emphasizing your unique approach and learning.`,
        `${basePrompt}\n\nTell a story highlighting team dynamics and collaboration.`
      ]
    }
    
    return variations[params.tone] || variations.professional
  }
  
  private static getRoleContext(role: RoleType): string {
    const contexts: Record<RoleType, string> = {
      tech: `You are assisting a software engineer writing job application answers.
Use technical vocabulary naturally. Reference common frameworks, methodologies, and tools.
Good placeholder examples: [specific framework name], [programming language], [team size], [years of experience]`,
      
      healthcare: `You are assisting a healthcare professional writing job application answers.
Use medical terminology appropriately. Reference clinical outcomes and patient care.
Good placeholder examples: [certification name], [patient volume], [department name], [years of experience]`,
      
      finance: `You are assisting a finance professional writing job application answers.
Use financial terminology naturally. Reference analytical skills and regulatory knowledge.
Good placeholder examples: [portfolio size], [specific regulation], [financial instrument], [years of experience]`,
      
      marketing: `You are assisting a marketing professional writing job application answers.
Use marketing terminology naturally. Reference campaigns, metrics, and audience targeting.
Good placeholder examples: [campaign name], [X% engagement increase], [target audience], [platform name]`,
      
      operations: `You are assisting an operations professional writing job application answers.
Use logistics and process terminology. Reference efficiency improvements and systems.
Good placeholder examples: [X% efficiency gain], [process name], [system name], [years of experience]`,
      
      other: `You are assisting a professional job seeker writing job application answers.
Use clear, professional language. Focus on transferable skills and achievements.
Good placeholder examples: [specific achievement], [X% improvement], [project name], [years of experience]`
    }
    
    return contexts[role]
  }
  
  private static getToneInstructions(tone: ToneVariant): string {
    const instructions: Record<ToneVariant, string> = {
      professional: `TONE: Professional (Neutral + Polished)
- Use clean, error-free language
- Be diplomatic without being overly formal
- Balance confidence with humility
- Avoid jargon unless role-appropriate`,
      
      concise: `TONE: Concise (Minimal but Complete)
- Use the shortest possible answer that fully addresses the question
- Every word must add value
- Prefer active voice and strong verbs
- Maximum 2-3 sentences for short answers, 4-5 for essays`,
      
      'story-driven': `TONE: Story-Driven (Narrative + Engaging)
- Use narrative elements: setup, challenge, action, resolution
- Create emotional connection through specific details (via placeholders)
- Show character development and learning
- Use vivid but professional language`
    }
    
    return instructions[tone]
  }
  
  private static getEssayInstructions(): string {
    return `FORMAT: STAR Outline Structure

Provide a structured outline using the STAR framework. DO NOT write a full essay.

Structure:
**Situation:** [1-2 sentences describing context and challenge]
- Tip: Set the stage with relevant background

**Task:** [1-2 sentences about your specific responsibility or goal]
- Tip: Make it clear what you were accountable for

**Action:** [3-4 bullet points describing steps taken]
• [First major action with specific detail placeholder]
• [Second major action with methodology placeholder]
• [Third action showing problem-solving]
• [Optional: Fourth action if relevant]
- Tip: Focus on YOUR actions, not the team's

**Result:** [2-3 sentences with quantifiable outcomes]
- Include: [X% improvement/increase], [measurable impact], [recognition received]
- Tip: Connect results back to the original challenge

Remember: This is an OUTLINE. The user will fill in their specific story using this structure.`
  }
  
  private static getShortAnswerInstructions(): string {
    return `FORMAT: Short Answer (2-4 sentences)

Provide a concise, direct answer to the question.
- First sentence: Direct answer or key qualification
- Second sentence: Supporting evidence or example (with placeholder)
- Optional third sentence: Additional relevant detail or outcome
- Final sentence: Connection to role or forward-looking statement

Keep it focused and easy to scan.`
  }
}
```

**Verification:**
- TypeScript compiles without errors
- All methods return expected string formats

---

### Task 2: Create Mock Answer Templates
**File:** `src/lib/ai/providers/templates.ts`
**Action:** Template structures for mock generation

```typescript
import type { ToneVariant, RoleType } from '@/types/ai'

export interface TemplateParams {
  question: string
  role: RoleType
  tone: ToneVariant
}

/**
 * Generate 3 STAR outline templates with variation
 */
export function getEssayTemplates(params: TemplateParams): [string, string, string] {
  const roleExamples = getRoleSpecificExamples(params.role)
  
  return [
    // Template 1: Structured outline style
    `**Situation:** In [specific time period/role context], I faced [specific challenge related to ${params.question}]. ${roleExamples.contextHint}

**Task:** My primary objective was to [specific goal or responsibility]. The key challenge was balancing [constraint 1] with [constraint 2].

**Action:** I approached this systematically:
• [First major action] - Specifically, I [methodology/tool used]
• [Second major action] - This involved [specific technique or approach]
• [Third major action] - To ensure success, I [verification or collaboration step]
• [Optional fourth action] - Additionally, I [improvement or adaptation]

**Result:** This led to [measurable outcome with X% improvement or Y metric]. ${roleExamples.outcomeHint} The experience taught me [key learning] and strengthened my [relevant skill].`,

    // Template 2: Challenge-focused style
    `**Situation:** [Brief context about your role and the environment when this occurred]
- The main challenge: [Specific problem that needed solving]
- Why it mattered: [Impact if left unresolved]

**Task:** I was responsible for [specific deliverable or goal]. Success meant [measurable definition of success].

**Action:** My strategy involved three key steps:
1. **[Action category 1]:** [Specific approach with tool/method placeholder]
   - ${roleExamples.actionExample1}
2. **[Action category 2]:** [Specific approach with collaboration placeholder]
   - ${roleExamples.actionExample2}
3. **[Action category 3]:** [Specific approach with outcome verification]
   - Validated through [specific metric or feedback mechanism]

**Result:** Successfully achieved [primary outcome] as measured by [X% metric or Y improvement]. This ${roleExamples.impactVerb} [broader organizational impact]. Recognized through [award/promotion/feedback].`,

    // Template 3: Learning-focused style
    `**Situation:** [Time period and organizational context]
- Challenge encountered: [Specific obstacle or opportunity]
- Initial constraints: [Resources, time, or knowledge gaps]

**Task:** The goal was to [specific objective] while [additional constraint or requirement]. This required [key skill or capability].

**Action:** I took the following approach:
• **Analysis:** [How you assessed the situation - include tool/framework placeholder]
• **Planning:** [How you designed the solution - include methodology placeholder]
• **Execution:** [How you implemented - include ${roleExamples.executionDetail}]
• **Iteration:** [How you refined based on feedback - include learning moment]

**Result:** 
- Primary outcome: [X% improvement in Y metric]
- Secondary benefits: [Additional positive impacts]
- Long-term impact: [How this influenced future work or team practices]
- Personal growth: [Skill developed or lesson learned]

${roleExamples.closingReflection}`
  ]
}

/**
 * Generate 3 short answer templates with variation
 */
export function getShortAnswerTemplates(params: TemplateParams): [string, string, string] {
  const roleExamples = getRoleSpecificExamples(params.role)
  
  const toneVariations = {
    professional: [
      `I bring ${roleExamples.qualification} to this challenge. In my role as [specific title] at [company], I [specific relevant achievement with X% metric]. This experience has equipped me with [key skill] that directly applies to [aspect of the question].`,
      
      `My background in ${roleExamples.domain} has prepared me well for this. Most notably, I [specific accomplishment] which resulted in [measurable outcome]. I'm particularly skilled at [relevant capability] and look forward to applying this to [aspect of role].`,
      
      `I would approach this by leveraging my experience with ${roleExamples.approach}. For example, at [company name], I [specific relevant action] leading to [X% improvement or Y result]. This demonstrates my ability to [key strength] in [relevant context].`
    ],
    
    concise: [
      `${roleExamples.directQualification}. At [company], I [action] resulting in [X% metric]. Strong [key skill].`,
      
      `[X years] experience in ${roleExamples.domain}. Key achievement: [specific result with metric]. Skilled in [relevant tool/method].`,
      
      `I would ${roleExamples.directApproach}. Previously achieved [measurable outcome] at [company]. Brings [key strength].`
    ],
    
    'story-driven': [
      `I discovered my strength in this area during ${roleExamples.narrativeSetup}. Facing [specific challenge], I realized that [key insight]. By [action taken], I was able to [achievement with metric]. This experience shaped my approach to [relevant skill area] and taught me the importance of [key learning].`,
      
      `The most defining moment in my ${roleExamples.narrativeDomain} came when [specific situation]. Rather than [conventional approach], I chose to [your unique approach]. The result? [Outcome with metric and broader impact]. This taught me that [key principle] and I've applied this lesson to every project since.`,
      
      `What excites me about this challenge is how it mirrors ${roleExamples.narrativeConnection}. When I [past situation], I learned that success requires [key insight]. By applying [specific methodology], I achieved [measurable result]. I'm eager to bring this same [quality/approach] to your team.`
    ]
  }
  
  return toneVariations[params.tone] as [string, string, string]
}

/**
 * Get role-specific example placeholders and hints
 */
function getRoleSpecificExamples(role: RoleType) {
  const examples: Record<RoleType, any> = {
    tech: {
      qualification: '[X years] of experience in [specific technology domain]',
      domain: '[technology stack] and [specific methodology like Agile/DevOps]',
      approach: '[specific framework or architecture pattern]',
      directQualification: '[X years] software engineering with focus on [specific domain]',
      directApproach: 'architect a solution using [technology] following [pattern]',
      contextHint: 'The codebase/system was [specific technical context].',
      outcomeHint: 'This improved [performance metric] and reduced [cost/time metric].',
      actionExample1: 'Implemented [specific technical solution] using [tool/framework]',
      actionExample2: 'Collaborated with [team] to integrate [technology]',
      executionDetail: 'specific commit/PR/deployment details',
      impactVerb: 'increased system',
      closingReflection: 'This strengthened my expertise in [technical area] and reinforced the value of [engineering principle].',
      narrativeSetup: 'a challenging [project type] at [company]',
      narrativeDomain: 'engineering career',
      narrativeConnection: 'a technical challenge I solved at [company]'
    },
    
    healthcare: {
      qualification: '[X years] of clinical experience in [specialty]',
      domain: '[clinical specialty] with focus on [patient population]',
      approach: '[evidence-based practice or clinical protocol]',
      directQualification: '[X years] [clinical role] specializing in [area]',
      directApproach: 'implement [clinical protocol] following [evidence-based guideline]',
      contextHint: 'The department served [patient volume] patients with [specific conditions].',
      outcomeHint: 'This improved patient outcomes by [X%] and increased [quality metric].',
      actionExample1: 'Implemented [clinical protocol] following [regulatory standard]',
      actionExample2: 'Collaborated with [department] to improve [patient care aspect]',
      executionDetail: 'specific patient outcome improvements',
      impactVerb: 'improved patient',
      closingReflection: 'This deepened my commitment to [care principle] and enhanced my ability to [clinical skill].',
      narrativeSetup: 'a critical patient care situation at [facility]',
      narrativeDomain: 'clinical career',
      narrativeConnection: 'a patient care challenge I addressed at [facility]'
    },
    
    finance: {
      qualification: '[X years] of experience in [financial domain]',
      domain: '[financial instruments/markets] with expertise in [specific area]',
      approach: '[analytical framework or financial model]',
      directQualification: '[X years] in [financial role] focusing on [specialization]',
      directApproach: 'analyze using [financial model] following [regulation/framework]',
      contextHint: 'The portfolio/project involved [dollar amount] across [asset classes].',
      outcomeHint: 'This generated [X% returns/savings] and reduced [risk metric].',
      actionExample1: 'Analyzed [financial instrument] using [model/tool] per [regulation]',
      actionExample2: 'Collaborated with [stakeholders] to optimize [financial metric]',
      executionDetail: 'specific risk mitigation or return optimization steps',
      impactVerb: 'increased portfolio',
      closingReflection: 'This strengthened my expertise in [financial area] and reinforced the importance of [financial principle].',
      narrativeSetup: 'a complex deal/analysis at [institution]',
      narrativeDomain: 'finance career',
      narrativeConnection: 'a financial challenge I solved at [institution]'
    },
    
    marketing: {
      qualification: '[X years] driving [marketing channel] campaigns',
      domain: '[marketing channel] with focus on [audience/industry]',
      approach: '[marketing framework or campaign strategy]',
      directQualification: '[X years] in [marketing role] specializing in [channel]',
      directApproach: 'execute [campaign type] using [platform] targeting [audience]',
      contextHint: 'The campaign targeted [audience size] across [channels].',
      outcomeHint: 'This increased [engagement/conversions] by [X%] and grew [business metric].',
      actionExample1: 'Launched [campaign type] on [platform] using [strategy]',
      actionExample2: 'Collaborated with [team] to optimize [metric]',
      executionDetail: 'specific A/B testing or optimization details',
      impactVerb: 'increased',
      closingReflection: 'This enhanced my skills in [marketing area] and proved the value of [marketing principle].',
      narrativeSetup: 'a high-stakes campaign at [company]',
      narrativeDomain: 'marketing career',
      narrativeConnection: 'a campaign challenge I solved at [company]'
    },
    
    operations: {
      qualification: '[X years] optimizing [operational domain]',
      domain: '[operational area] with focus on [process/system]',
      approach: '[operational framework or methodology]',
      directQualification: '[X years] in [operations role] focusing on [specialization]',
      directApproach: 'streamline [process] using [methodology] to improve [metric]',
      contextHint: 'The operation handled [volume] across [locations/systems].',
      outcomeHint: 'This reduced [cost/time] by [X%] and improved [efficiency metric].',
      actionExample1: 'Optimized [process] using [tool/methodology]',
      actionExample2: 'Collaborated with [stakeholders] to implement [system improvement]',
      executionDetail: 'specific process improvements or efficiency gains',
      impactVerb: 'improved operational',
      closingReflection: 'This strengthened my expertise in [operational area] and demonstrated the value of [operations principle].',
      narrativeSetup: 'a critical process challenge at [company]',
      narrativeDomain: 'operations career',
      narrativeConnection: 'an operational challenge I solved at [company]'
    },
    
    other: {
      qualification: '[X years] of professional experience in [domain]',
      domain: '[professional area] with focus on [specialization]',
      approach: '[methodology or framework]',
      directQualification: '[X years] in [role] with focus on [area]',
      directApproach: 'apply [skill/method] to achieve [objective]',
      contextHint: 'The project/role involved [scope] with [stakeholders].',
      outcomeHint: 'This achieved [X% improvement] in [relevant metric].',
      actionExample1: 'Implemented [solution] using [approach]',
      actionExample2: 'Collaborated with [team] to deliver [outcome]',
      executionDetail: 'specific actions and results',
      impactVerb: 'improved',
      closingReflection: 'This experience strengthened my [skill] and reinforced the importance of [principle].',
      narrativeSetup: 'a significant project at [organization]',
      narrativeDomain: 'professional career',
      narrativeConnection: 'a challenge I addressed at [organization]'
    }
  }
  
  return examples[role] || examples.other
}
```

**Verification:**
- Template functions compile
- All role types covered
- Templates include clear placeholders

---

### Task 3: Implement Mock Provider
**File:** `src/lib/ai/providers/mock.ts`
**Action:** Mock AI provider using templates

```typescript
import { BaseAIProvider } from './base'
import type { GenerateParams, GenerateResult, AIProvider } from '@/types/ai'
import { getEssayTemplates, getShortAnswerTemplates } from './templates'

export class MockProvider extends BaseAIProvider {
  readonly name: AIProvider = 'mock'
  readonly supportsStreaming = false
  
  async generateAnswer(params: GenerateParams): Promise<GenerateResult> {
    // Simulate slight delay for realism
    await this.simulateDelay()
    
    const drafts = params.essayMode
      ? getEssayTemplates({
          question: params.question,
          role: params.role,
          tone: params.tone
        })
      : getShortAnswerTemplates({
          question: params.question,
          role: params.role,
          tone: params.tone
        })
    
    return {
      drafts,
      provider: 'mock',
      tones: [params.tone, params.tone, params.tone],
      metadata: {
        essayMode: params.essayMode,
        generatedAt: Date.now(),
        question: params.question
      }
    }
  }
  
  /**
   * Mock provider doesn't need validation (always available)
   */
  async validateKey(): Promise<boolean> {
    return true
  }
  
  /**
   * Simulate API delay for realism (300-600ms)
   */
  private async simulateDelay(): Promise<void> {
    const delay = 300 + Math.random() * 300
    await new Promise(resolve => setTimeout(resolve, delay))
  }
}
```

**Verification:**
- TypeScript compiles
- Implements IAIProvider interface
- Returns correct result structure

---

### Task 4: Update Factory to Support Mock Provider
**File:** `src/lib/ai/factory.ts`
**Action:** Uncomment mock provider instantiation

```typescript
import type { IAIProvider, AIProvider } from '@/types/ai'
import { getAIConfig, getAPIKey } from './config'
import { MockProvider } from './providers/mock'

// Import other providers (will be implemented in Plan 03-03)
// import { OpenAIProvider } from './providers/openai'
// import { AnthropicProvider } from './providers/anthropic'

/**
 * Get the appropriate AI provider based on current configuration
 */
export async function getAIProvider(): Promise<IAIProvider> {
  const config = await getAIConfig()
  
  switch (config.provider) {
    case 'openai': {
      const apiKey = await getAPIKey('openai')
      if (!apiKey) {
        // Fall back to mock if no key
        console.warn('OpenAI provider selected but no API key found. Falling back to mock.')
        return new MockProvider()
      }
      // return new OpenAIProvider(apiKey)
      throw new Error('OpenAI provider not yet implemented')
    }
    
    case 'anthropic': {
      const apiKey = await getAPIKey('anthropic')
      if (!apiKey) {
        console.warn('Anthropic provider selected but no API key found. Falling back to mock.')
        return new MockProvider()
      }
      // return new AnthropicProvider(apiKey)
      throw new Error('Anthropic provider not yet implemented')
    }
    
    case 'mock':
    default:
      return new MockProvider()
  }
}

/**
 * Create provider instance for validation (doesn't save to config)
 */
export async function createProviderForValidation(
  provider: 'openai' | 'anthropic',
  apiKey: string
): Promise<IAIProvider> {
  switch (provider) {
    case 'openai':
      // return new OpenAIProvider(apiKey)
      throw new Error('OpenAI provider not yet implemented')
    
    case 'anthropic':
      // return new AnthropicProvider(apiKey)
      throw new Error('Anthropic provider not yet implemented')
    
    default:
      throw new Error(`Unknown provider: ${provider}`)
  }
}
```

**Verification:**
- Mock provider instantiates successfully
- Factory returns MockProvider for 'mock' config

---

### Task 5: Create Prompt Builder Tests
**File:** `src/lib/ai/prompt-builder.test.ts`
**Action:** Test prompt generation logic

```typescript
import { describe, it, expect } from 'vitest'
import { PromptBuilder } from './prompt-builder'

describe('PromptBuilder', () => {
  describe('buildSystemPrompt', () => {
    it('should include role context for tech role', () => {
      const prompt = PromptBuilder.buildSystemPrompt({
        role: 'tech',
        tone: 'professional',
        essayMode: false
      })
      
      expect(prompt).toContain('software engineer')
      expect(prompt).toContain('technical vocabulary')
    })
    
    it('should include professional tone instructions', () => {
      const prompt = PromptBuilder.buildSystemPrompt({
        role: 'tech',
        tone: 'professional',
        essayMode: false
      })
      
      expect(prompt).toContain('polished')
      expect(prompt).toContain('diplomatic')
    })
    
    it('should include STAR instructions for essay mode', () => {
      const prompt = PromptBuilder.buildSystemPrompt({
        role: 'tech',
        tone: 'professional',
        essayMode: true
      })
      
      expect(prompt).toContain('STAR')
      expect(prompt).toContain('Situation')
      expect(prompt).toContain('Task')
      expect(prompt).toContain('Action')
      expect(prompt).toContain('Result')
    })
    
    it('should include short answer instructions for non-essay mode', () => {
      const prompt = PromptBuilder.buildSystemPrompt({
        role: 'tech',
        tone: 'concise',
        essayMode: false
      })
      
      expect(prompt).toContain('2-4 sentences')
      expect(prompt).not.toContain('STAR')
    })
  })
  
  describe('buildUserPrompt', () => {
    it('should include question text', () => {
      const prompt = PromptBuilder.buildUserPrompt({
        question: 'Why do you want to work here?'
      })
      
      expect(prompt).toContain('Why do you want to work here?')
    })
    
    it('should include context when provided', () => {
      const prompt = PromptBuilder.buildUserPrompt({
        question: 'Describe your experience',
        questionContext: 'Previous field label: Years of Experience'
      })
      
      expect(prompt).toContain('Years of Experience')
    })
  })
  
  describe('buildPromptVariants', () => {
    it('should return 3 variants', () => {
      const variants = PromptBuilder.buildPromptVariants({
        question: 'Why this role?',
        tone: 'professional'
      })
      
      expect(variants).toHaveLength(3)
    })
    
    it('should have different emphases in each variant', () => {
      const variants = PromptBuilder.buildPromptVariants({
        question: 'Why this role?',
        tone: 'professional'
      })
      
      expect(variants[0]).not.toBe(variants[1])
      expect(variants[1]).not.toBe(variants[2])
    })
  })
})
```

---

### Task 6: Create Mock Provider Tests
**File:** `src/lib/ai/providers/mock.test.ts`
**Action:** Test mock provider

```typescript
import { describe, it, expect } from 'vitest'
import { MockProvider } from './mock'
import type { GenerateParams } from '@/types/ai'
import type { Profile } from '@/types/profile'

describe('MockProvider', () => {
  const mockProfile: Profile = {
    personalInfo: {
      fullName: 'Test User',
      email: 'test@example.com',
      phone: '555-1234',
      location: 'Test City'
    },
    workExperience: [],
    education: [],
    skills: [],
    links: {},
    rolePreference: 'tech'
  }
  
  const provider = new MockProvider()
  
  describe('generateAnswer', () => {
    it('should return 3 drafts for short answer', async () => {
      const params: GenerateParams = {
        question: 'Why do you want this role?',
        userProfile: mockProfile,
        tone: 'professional',
        essayMode: false,
        role: 'tech'
      }
      
      const result = await provider.generateAnswer(params)
      
      expect(result.drafts).toHaveLength(3)
      expect(result.provider).toBe('mock')
      expect(result.metadata.essayMode).toBe(false)
    })
    
    it('should return STAR outlines for essay mode', async () => {
      const params: GenerateParams = {
        question: 'Describe a challenging project',
        userProfile: mockProfile,
        tone: 'professional',
        essayMode: true,
        role: 'tech'
      }
      
      const result = await provider.generateAnswer(params)
      
      expect(result.drafts).toHaveLength(3)
      expect(result.drafts[0]).toContain('**Situation:**')
      expect(result.drafts[0]).toContain('**Task:**')
      expect(result.drafts[0]).toContain('**Action:**')
      expect(result.drafts[0]).toContain('**Result:**')
      expect(result.metadata.essayMode).toBe(true)
    })
    
    it('should include placeholders in all drafts', async () => {
      const params: GenerateParams = {
        question: 'What is your greatest strength?',
        userProfile: mockProfile,
        tone: 'professional',
        essayMode: false,
        role: 'tech'
      }
      
      const result = await provider.generateAnswer(params)
      
      // All drafts should have placeholders in brackets
      const placeholderPattern = /\[.*?\]/
      result.drafts.forEach(draft => {
        expect(draft).toMatch(placeholderPattern)
      })
    })
    
    it('should include role-specific content for tech role', async () => {
      const params: GenerateParams = {
        question: 'What technologies do you use?',
        userProfile: mockProfile,
        tone: 'professional',
        essayMode: false,
        role: 'tech'
      }
      
      const result = await provider.generateAnswer(params)
      
      // Should contain tech-specific placeholders
      const allDrafts = result.drafts.join(' ')
      expect(
        allDrafts.includes('technology') ||
        allDrafts.includes('framework') ||
        allDrafts.includes('engineering')
      ).toBe(true)
    })
    
    it('should simulate realistic delay', async () => {
      const params: GenerateParams = {
        question: 'Test question',
        userProfile: mockProfile,
        tone: 'professional',
        essayMode: false,
        role: 'tech'
      }
      
      const start = Date.now()
      await provider.generateAnswer(params)
      const duration = Date.now() - start
      
      // Should take 300-600ms
      expect(duration).toBeGreaterThanOrEqual(300)
      expect(duration).toBeLessThan(700)
    })
  })
  
  describe('validateKey', () => {
    it('should always return true for mock provider', async () => {
      const result = await provider.validateKey('fake-key')
      expect(result).toBe(true)
    })
  })
})
```

---

## Dependencies

- Plan 03-01 complete (provider infrastructure exists)
- TypeScript and Vitest configured

---

## Success Criteria

- [ ] All TypeScript files compile without errors
- [ ] `pnpm type-check` passes
- [ ] All unit tests pass
- [ ] PromptBuilder generates correct system prompts for all roles/tones
- [ ] Mock provider returns 3 distinct drafts
- [ ] STAR outlines generated for essay mode
- [ ] Short answers generated for non-essay mode
- [ ] All templates include clear placeholders in [brackets]
- [ ] Role-specific content appears in templates
- [ ] Mock provider simulates realistic delay

---

## Non-Goals (Deferred to Later Plans)

- Real AI provider implementations (Plan 03-03)
- Question detection logic (Plan 03-04)
- UI components (Plans 03-04, 03-05)

---

## Rollback Plan

If critical issues found:
1. Revert commit for this plan
2. Keep Plan 03-01 infrastructure
3. Remove `src/lib/ai/providers/mock.ts` and `templates.ts`
4. Remove `src/lib/ai/prompt-builder.ts`

---

**End of Plan 03-02**
