# Plan 03-05: API Key Configuration & Settings UI

**Phase:** 3 - AI Answer Generation
**Wave:** 3 (parallel with 03-04)
**Priority:** P1 (Should-Have)
**Estimated Duration:** 35 minutes

---

## Goal

Build the settings UI for AI configuration, including API key entry, validation, provider selection, and key management. Enables users to add their OpenAI or Anthropic API keys, validate them before saving, and switch between providers.

---

## Context

From CONTEXT.md:
- Both OpenAI + Claude support (user chooses provider)
- Settings page section for AI configuration
- Retry validation: test API key with real call before saving, allow retry if fails

From RESEARCH.md:
- Show clear success/failure message on validation
- Allow retry without re-entering full key
- Store validation timestamp
- Lightweight validation calls: OpenAI models.list(), Anthropic minimal message

---

## Requirements Covered

- REQ-AI-02: User-provided API key support (UI complete)

---

## Tasks

### Task 1: Create AI Settings Component
**File:** `src/components/AISettings.tsx`
**Action:** Settings section for AI configuration

```typescript
import React, { useState, useEffect } from 'react'
import {
  getAIConfig,
  setAIProvider,
  saveAPIKey,
  clearAPIKey,
  hasValidKey,
  createProviderForValidation
} from '@/lib/ai'
import type { AIConfig, AIProvider } from '@/types/ai'

export function AISettings() {
  const [config, setConfig] = useState<AIConfig | null>(null)
  const [openaiKey, setOpenaiKey] = useState('')
  const [anthropicKey, setAnthropicKey] = useState('')
  const [isValidatingOpenAI, setIsValidatingOpenAI] = useState(false)
  const [isValidatingAnthropic, setIsValidatingAnthropic] = useState(false)
  const [openaiValidation, setOpenaiValidation] = useState<'success' | 'error' | null>(null)
  const [anthropicValidation, setAnthropicValidation] = useState<'success' | 'error' | null>(null)
  const [openaiError, setOpenaiError] = useState('')
  const [anthropicError, setAnthropicError] = useState('')
  const [hasOpenAIKey, setHasOpenAIKey] = useState(false)
  const [hasAnthropicKey, setHasAnthropicKey] = useState(false)
  
  // Load config on mount
  useEffect(() => {
    loadConfig()
  }, [])
  
  const loadConfig = async () => {
    const aiConfig = await getAIConfig()
    setConfig(aiConfig)
    
    const [openaiValid, anthropicValid] = await Promise.all([
      hasValidKey('openai'),
      hasValidKey('anthropic')
    ])
    
    setHasOpenAIKey(openaiValid)
    setHasAnthropicKey(anthropicValid)
  }
  
  const handleOpenAIValidate = async () => {
    if (!openaiKey.trim()) {
      setOpenaiError('Please enter an API key')
      return
    }
    
    if (!openaiKey.startsWith('sk-')) {
      setOpenaiError('OpenAI keys should start with "sk-"')
      return
    }
    
    setIsValidatingOpenAI(true)
    setOpenaiValidation(null)
    setOpenaiError('')
    
    try {
      const provider = await createProviderForValidation('openai', openaiKey)
      const isValid = await provider.validateKey!(openaiKey)
      
      if (isValid) {
        // Save key
        await saveAPIKey('openai', openaiKey, Date.now())
        setOpenaiValidation('success')
        setOpenaiKey('') // Clear input
        setHasOpenAIKey(true)
        
        // Auto-select OpenAI if no provider selected
        if (config?.provider === 'mock') {
          await setAIProvider('openai')
          await loadConfig()
        }
      } else {
        setOpenaiValidation('error')
        setOpenaiError('Invalid API key. Please check and try again.')
      }
    } catch (error: any) {
      setOpenaiValidation('error')
      setOpenaiError(error.message || 'Validation failed')
    } finally {
      setIsValidatingOpenAI(false)
    }
  }
  
  const handleAnthropicValidate = async () => {
    if (!anthropicKey.trim()) {
      setAnthropicError('Please enter an API key')
      return
    }
    
    if (!anthropicKey.startsWith('sk-ant-')) {
      setAnthropicError('Anthropic keys should start with "sk-ant-"')
      return
    }
    
    setIsValidatingAnthropic(true)
    setAnthropicValidation(null)
    setAnthropicError('')
    
    try {
      const provider = await createProviderForValidation('anthropic', anthropicKey)
      const isValid = await provider.validateKey!(anthropicKey)
      
      if (isValid) {
        await saveAPIKey('anthropic', anthropicKey, Date.now())
        setAnthropicValidation('success')
        setAnthropicKey('')
        setHasAnthropicKey(true)
        
        if (config?.provider === 'mock') {
          await setAIProvider('anthropic')
          await loadConfig()
        }
      } else {
        setAnthropicValidation('error')
        setAnthropicError('Invalid API key. Please check and try again.')
      }
    } catch (error: any) {
      setAnthropicValidation('error')
      setAnthropicError(error.message || 'Validation failed')
    } finally {
      setIsValidatingAnthropic(false)
    }
  }
  
  const handleProviderChange = async (provider: AIProvider) => {
    // Check if provider has valid key
    if (provider === 'openai' && !hasOpenAIKey) {
      alert('Please add and validate an OpenAI API key first')
      return
    }
    
    if (provider === 'anthropic' && !hasAnthropicKey) {
      alert('Please add and validate an Anthropic API key first')
      return
    }
    
    await setAIProvider(provider)
    await loadConfig()
  }
  
  const handleRemoveOpenAI = async () => {
    if (confirm('Remove OpenAI API key? This will switch to Mock AI mode.')) {
      await clearAPIKey('openai')
      setHasOpenAIKey(false)
      setOpenaiValidation(null)
      await loadConfig()
    }
  }
  
  const handleRemoveAnthropic = async () => {
    if (confirm('Remove Anthropic API key? This will switch to Mock AI mode.')) {
      await clearAPIKey('anthropic')
      setHasAnthropicKey(false)
      setAnthropicValidation(null)
      await loadConfig()
    }
  }
  
  if (!config) {
    return <div className="text-gray-500">Loading...</div>
  }
  
  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-xl font-semibold text-gray-900 mb-2">AI Configuration</h2>
        <p className="text-sm text-gray-600">
          Configure AI providers for answer suggestions. Mock AI is free but uses templates. 
          Add your API key for real AI-generated answers.
        </p>
      </div>
      
      {/* Provider Selection */}
      <div className="bg-white border border-gray-200 rounded-lg p-4">
        <h3 className="text-sm font-medium text-gray-900 mb-3">Active Provider</h3>
        
        <div className="space-y-2">
          {/* Mock AI */}
          <label className="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
            <input
              type="radio"
              name="provider"
              value="mock"
              checked={config.provider === 'mock'}
              onChange={() => handleProviderChange('mock')}
              className="h-4 w-4 text-blue-600"
            />
            <div className="flex-1">
              <div className="font-medium text-gray-900">Mock AI (Free)</div>
              <div className="text-xs text-gray-500">Template-based suggestions with placeholders</div>
            </div>
            <span className="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded">Free</span>
          </label>
          
          {/* OpenAI */}
          <label className="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
            <input
              type="radio"
              name="provider"
              value="openai"
              checked={config.provider === 'openai'}
              onChange={() => handleProviderChange('openai')}
              disabled={!hasOpenAIKey}
              className="h-4 w-4 text-blue-600 disabled:opacity-50"
            />
            <div className="flex-1">
              <div className="font-medium text-gray-900">OpenAI GPT-4o</div>
              <div className="text-xs text-gray-500">
                {hasOpenAIKey ? 'API key configured ✓' : 'Requires API key (add below)'}
              </div>
            </div>
            <span className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">Paid</span>
          </label>
          
          {/* Anthropic */}
          <label className="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
            <input
              type="radio"
              name="provider"
              value="anthropic"
              checked={config.provider === 'anthropic'}
              onChange={() => handleProviderChange('anthropic')}
              disabled={!hasAnthropicKey}
              className="h-4 w-4 text-blue-600 disabled:opacity-50"
            />
            <div className="flex-1">
              <div className="font-medium text-gray-900">Anthropic Claude</div>
              <div className="text-xs text-gray-500">
                {hasAnthropicKey ? 'API key configured ✓' : 'Requires API key (add below)'}
              </div>
            </div>
            <span className="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded">Paid</span>
          </label>
        </div>
      </div>
      
      {/* OpenAI API Key */}
      <div className="bg-white border border-gray-200 rounded-lg p-4">
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-sm font-medium text-gray-900">OpenAI API Key</h3>
          {hasOpenAIKey && (
            <button
              onClick={handleRemoveOpenAI}
              className="text-xs text-red-600 hover:text-red-700"
            >
              Remove Key
            </button>
          )}
        </div>
        
        {hasOpenAIKey ? (
          <div className="bg-green-50 border border-green-200 rounded p-3">
            <p className="text-sm text-green-800">
              ✓ OpenAI API key configured and validated
            </p>
            <p className="text-xs text-green-600 mt-1">
              Validated: {new Date(config.openaiValidatedAt!).toLocaleString()}
            </p>
          </div>
        ) : (
          <>
            <div className="space-y-2">
              <input
                type="password"
                value={openaiKey}
                onChange={(e) => {
                  setOpenaiKey(e.target.value)
                  setOpenaiValidation(null)
                  setOpenaiError('')
                }}
                placeholder="sk-..."
                className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              
              <button
                onClick={handleOpenAIValidate}
                disabled={isValidatingOpenAI || !openaiKey.trim()}
                className="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
              >
                {isValidatingOpenAI ? 'Validating...' : 'Validate & Save'}
              </button>
            </div>
            
            {openaiValidation === 'error' && (
              <div className="mt-2 bg-red-50 border border-red-200 rounded p-3">
                <p className="text-sm text-red-800">✗ {openaiError}</p>
                <p className="text-xs text-red-600 mt-1">
                  Check your key at <a href="https://platform.openai.com/api-keys" target="_blank" className="underline">platform.openai.com</a>
                </p>
              </div>
            )}
            
            <p className="text-xs text-gray-500 mt-2">
              Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" className="text-blue-600 hover:underline">OpenAI Platform</a>
            </p>
          </>
        )}
      </div>
      
      {/* Anthropic API Key */}
      <div className="bg-white border border-gray-200 rounded-lg p-4">
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-sm font-medium text-gray-900">Anthropic API Key</h3>
          {hasAnthropicKey && (
            <button
              onClick={handleRemoveAnthropic}
              className="text-xs text-red-600 hover:text-red-700"
            >
              Remove Key
            </button>
          )}
        </div>
        
        {hasAnthropicKey ? (
          <div className="bg-green-50 border border-green-200 rounded p-3">
            <p className="text-sm text-green-800">
              ✓ Anthropic API key configured and validated
            </p>
            <p className="text-xs text-green-600 mt-1">
              Validated: {new Date(config.anthropicValidatedAt!).toLocaleString()}
            </p>
          </div>
        ) : (
          <>
            <div className="space-y-2">
              <input
                type="password"
                value={anthropicKey}
                onChange={(e) => {
                  setAnthropicKey(e.target.value)
                  setAnthropicValidation(null)
                  setAnthropicError('')
                }}
                placeholder="sk-ant-..."
                className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              
              <button
                onClick={handleAnthropicValidate}
                disabled={isValidatingAnthropic || !anthropicKey.trim()}
                className="w-full px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
              >
                {isValidatingAnthropic ? 'Validating...' : 'Validate & Save'}
              </button>
            </div>
            
            {anthropicValidation === 'error' && (
              <div className="mt-2 bg-red-50 border border-red-200 rounded p-3">
                <p className="text-sm text-red-800">✗ {anthropicError}</p>
                <p className="text-xs text-red-600 mt-1">
                  Check your key at <a href="https://console.anthropic.com/settings/keys" target="_blank" className="underline">console.anthropic.com</a>
                </p>
              </div>
            )}
            
            <p className="text-xs text-gray-500 mt-2">
              Get your API key from <a href="https://console.anthropic.com/settings/keys" target="_blank" className="text-blue-600 hover:underline">Anthropic Console</a>
            </p>
          </>
        )}
      </div>
      
      {/* Privacy Notice */}
      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div className="flex gap-3">
          <svg className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
          </svg>
          <div className="text-sm text-blue-900">
            <p className="font-medium mb-1">Privacy & Security</p>
            <p className="text-blue-800">
              Your API keys are stored locally in your browser only. They are never sent to any server except directly to OpenAI/Anthropic when generating answers. 
              You can remove them at any time.
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}
```

**Verification:**
- Component renders correctly
- Provider selection works
- API key validation successful
- Error states display properly
- Keys saved to storage

---

### Task 2: Integrate AI Settings into Options Page
**File:** `src/entrypoints/options/App.tsx`
**Action:** Add AI settings section

```typescript
import React, { useState } from 'react'
import { ProfileEditor } from '@/components/ProfileEditor'
import { AISettings } from '@/components/AISettings'

export function App() {
  const [activeTab, setActiveTab] = useState<'profile' | 'ai' | 'data'>('profile')
  
  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white border-b border-gray-200">
        <div className="max-w-5xl mx-auto px-6 py-4">
          <h1 className="text-2xl font-bold text-gray-900">AutoApply Copilot Settings</h1>
        </div>
      </header>
      
      <div className="max-w-5xl mx-auto px-6 py-8">
        {/* Tabs */}
        <div className="flex gap-4 mb-8 border-b border-gray-200">
          <button
            onClick={() => setActiveTab('profile')}
            className={`px-4 py-2 font-medium border-b-2 transition-colors ${
              activeTab === 'profile'
                ? 'border-blue-600 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            Profile
          </button>
          <button
            onClick={() => setActiveTab('ai')}
            className={`px-4 py-2 font-medium border-b-2 transition-colors ${
              activeTab === 'ai'
                ? 'border-blue-600 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            AI Configuration
          </button>
          <button
            onClick={() => setActiveTab('data')}
            className={`px-4 py-2 font-medium border-b-2 transition-colors ${
              activeTab === 'data'
                ? 'border-blue-600 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            Data & Privacy
          </button>
        </div>
        
        {/* Tab Content */}
        <div>
          {activeTab === 'profile' && <ProfileEditor />}
          {activeTab === 'ai' && <AISettings />}
          {activeTab === 'data' && <DataSettings />}
        </div>
      </div>
    </div>
  )
}

function DataSettings() {
  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-xl font-semibold text-gray-900 mb-2">Data & Privacy</h2>
        <p className="text-sm text-gray-600">
          Manage your data and privacy settings
        </p>
      </div>
      
      <div className="bg-white border border-gray-200 rounded-lg p-4">
        <p className="text-sm text-gray-600">
          Data management features (export/delete) coming in Phase 1 completion.
        </p>
      </div>
    </div>
  )
}
```

**Verification:**
- Tabs work correctly
- AI Settings tab shows configuration
- Navigation between tabs persists state

---

### Task 3: Create Storage Migration (if needed)
**File:** `src/lib/ai/migration.ts`
**Action:** Handle any config format changes

```typescript
import { getAIConfig } from './config'
import type { AIConfig } from '@/types/ai'

/**
 * Migrate AI config to current version
 * (Reserved for future schema changes)
 */
export async function migrateAIConfig(): Promise<void> {
  const config = await getAIConfig()
  
  // Version 1: Current format - no migration needed
  // Future migrations would go here
  
  console.log('[AI Config] Migration check complete. Config version: 1')
}
```

---

### Task 4: Add Settings Link to Popup
**File:** `src/entrypoints/popup/App.tsx`
**Action:** Add link to AI settings

```typescript
// Add to existing popup

function SettingsLink() {
  const handleOpenSettings = () => {
    chrome.runtime.openOptionsPage()
  }
  
  return (
    <button
      onClick={handleOpenSettings}
      className="flex items-center gap-2 w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"
    >
      <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      Settings (Configure AI)
    </button>
  )
}
```

---

### Task 5: Create AI Settings Tests
**File:** `src/components/AISettings.test.tsx`

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { AISettings } from './AISettings'
import * as aiLib from '@/lib/ai'

vi.mock('@/lib/ai')

describe('AISettings', () => {
  beforeEach(() => {
    vi.clearAllMocks()
    
    vi.mocked(aiLib.getAIConfig).mockResolvedValue({
      provider: 'mock',
      lastUsedProvider: 'mock'
    })
    
    vi.mocked(aiLib.hasValidKey).mockResolvedValue(false)
  })
  
  it('should render provider selection', async () => {
    render(<AISettings />)
    
    await waitFor(() => {
      expect(screen.getByText(/Mock AI \(Free\)/i)).toBeInTheDocument()
      expect(screen.getByText(/OpenAI GPT-4o/i)).toBeInTheDocument()
      expect(screen.getByText(/Anthropic Claude/i)).toBeInTheDocument()
    })
  })
  
  it('should show API key input for OpenAI', async () => {
    render(<AISettings />)
    
    await waitFor(() => {
      expect(screen.getByPlaceholderText('sk-...')).toBeInTheDocument()
    })
  })
  
  it('should validate OpenAI key format', async () => {
    render(<AISettings />)
    
    await waitFor(() => screen.getByPlaceholderText('sk-...'))
    
    const input = screen.getByPlaceholderText('sk-...')
    const button = screen.getByText('Validate & Save')
    
    fireEvent.change(input, { target: { value: 'invalid-key' } })
    fireEvent.click(button)
    
    await waitFor(() => {
      expect(screen.getByText(/should start with "sk-"/i)).toBeInTheDocument()
    })
  })
  
  it('should call validation on valid key', async () => {
    const mockProvider = {
      validateKey: vi.fn().mockResolvedValue(true)
    }
    
    vi.mocked(aiLib.createProviderForValidation).mockResolvedValue(mockProvider as any)
    vi.mocked(aiLib.saveAPIKey).mockResolvedValue(undefined)
    
    render(<AISettings />)
    
    await waitFor(() => screen.getByPlaceholderText('sk-...'))
    
    const input = screen.getByPlaceholderText('sk-...')
    const button = screen.getByText('Validate & Save')
    
    fireEvent.change(input, { target: { value: 'sk-test-key' } })
    fireEvent.click(button)
    
    await waitFor(() => {
      expect(aiLib.createProviderForValidation).toHaveBeenCalledWith('openai', 'sk-test-key')
      expect(mockProvider.validateKey).toHaveBeenCalled()
      expect(aiLib.saveAPIKey).toHaveBeenCalled()
    })
  })
})
```

---

### Task 6: Update WXT Config for Options Page
**File:** `wxt.config.ts`
**Action:** Ensure options page configured

```typescript
import { defineConfig } from 'wxt'

export default defineConfig({
  modules: ['@wxt-dev/module-react'],
  manifest: {
    permissions: ['storage', 'activeTab', 'declarativeContent'],
    // ... other config
  },
  entrypoints: {
    // ... existing entrypoints
    options: {
      type: 'page',
      title: 'AutoApply Copilot Settings'
    }
  }
})
```

---

## Dependencies

- Plans 03-01, 03-02, 03-03 complete (providers and config ready)
- React and Tailwind configured
- Options page structure exists

---

## Success Criteria

- [ ] AI Settings component renders in options page
- [ ] Provider selection (Mock/OpenAI/Anthropic) works
- [ ] OpenAI API key validation successful
- [ ] Anthropic API key validation successful
- [ ] Error states display properly
- [ ] Success states show validation timestamp
- [ ] Key removal works correctly
- [ ] Auto-switches to provider after validation
- [ ] Privacy notice displayed
- [ ] Links to get API keys work
- [ ] All tests pass

---

## Manual Testing Checklist

1. **Mock AI (default):**
   - Mock selected by default
   - No API key required
   
2. **OpenAI validation:**
   - Invalid format → shows error
   - Invalid key → shows error with retry
   - Valid key → saves and switches provider
   
3. **Anthropic validation:**
   - Invalid format → shows error
   - Invalid key → shows error with retry
   - Valid key → saves and switches provider
   
4. **Provider switching:**
   - Can switch to provider with valid key
   - Cannot switch to provider without key
   - Switching updates active provider immediately
   
5. **Key removal:**
   - Removing key shows confirmation
   - Removal switches back to mock if active
   - Removed key no longer appears as configured

---

## Non-Goals (Deferred)

- Tone selection UI (v2 - users use Regenerate for variation)
- Usage tracking/cost estimation (v2)
- Multiple API key support per provider (v2)
- Custom prompt templates (v2)

---

## Rollback Plan

If critical issues:
1. Revert commit
2. Keep all previous plans (03-01 through 03-04)
3. Remove AISettings component
4. Remove settings integration

---

**End of Plan 03-05**
