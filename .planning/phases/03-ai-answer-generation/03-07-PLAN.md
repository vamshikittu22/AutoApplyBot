---
phase: 03-ai-answer-generation
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/prompt-builder.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All Phase 3 tests passing (8/8 in prompt-builder.test.ts)"
    - "Test assertions match actual prompt builder output"
  artifacts:
    - path: "src/lib/ai/prompt-builder.test.ts"
      provides: "Updated test expectations for tone instructions"
      contains: "Polished"
      modified: true
  key_links:
    - from: "prompt-builder.test.ts"
      to: "prompt-builder.ts"
      via: "buildSystemPrompt() output verification"
      pattern: "expect.*toContain"
---

<objective>
Fix failing test in prompt-builder.test.ts to close VERIFICATION.md Gap 2 (non-blocker).

Purpose: One test assertion is failing because it expects lowercase "polished" but the actual prompt uses "Polished" (capitalized). This is a minor test expectation mismatch, not a functional bug.

Output: Updated test assertion to match actual prompt builder output
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/kittu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-ai-answer-generation/03-VERIFICATION.md
@src/lib/ai/prompt-builder.test.ts
@src/lib/ai/prompt-builder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix failing test assertion for tone instructions</name>
  <files>src/lib/ai/prompt-builder.test.ts</files>
  <action>
Update test assertions in "should include professional tone instructions" test (lines 17-26):

**Current failing assertion:**
```typescript
expect(prompt).toContain('polished');  // Line 24 - FAILS (lowercase)
expect(prompt).toContain('diplomatic');  // Line 25
```

**Actual prompt output:**
```
TONE: Professional (Neutral + Polished)
- Use clean, error-free language
- Be diplomatic without being overly formal
```

**Fix:**
```typescript
it('should include professional tone instructions', () => {
  const prompt = PromptBuilder.buildSystemPrompt({
    role: 'tech',
    tone: 'professional',
    essayMode: false,
  });

  // Check for capitalized version as it appears in tone header
  expect(prompt).toContain('Polished');  // Capitalized in "Neutral + Polished"
  expect(prompt).toContain('diplomatic');  // Lowercase in bullet point (correct)
});
```

**Why this fix:**
- The actual prompt uses "Polished" (capitalized) in the tone header
- "diplomatic" is lowercase in the bullet point description
- Test should match actual output, not assumed output
- This is a case-sensitivity issue in test expectations, not a bug in prompt builder

**Alternative (if you want case-insensitive matching):**
```typescript
expect(prompt.toLowerCase()).toContain('polished');
expect(prompt.toLowerCase()).toContain('diplomatic');
```
But prefer the first fix (match actual casing) for specificity.

**Verify no other tone tests have same issue:**
- Check "concise" tone test assertions
- Check "story-driven" tone test assertions (if any)
- Ensure consistency across all tone instruction tests
  </action>
  <verify>pnpm test src/lib/ai/prompt-builder.test.ts passes all 8 tests</verify>
  <done>Test assertion updated to expect "Polished" (capitalized), all prompt-builder tests passing</done>
</task>

</tasks>

<verification>
Run verification checks:

1. **Test suite verification:**
   ```bash
   pnpm test src/lib/ai/prompt-builder.test.ts
   ```
   Expected output: "8 passed" (was 7 passed, 1 failed)

2. **All AI tests:**
   ```bash
   pnpm test src/lib/ai/
   ```
   All AI subsystem tests should pass.

3. **Gap closure verification:**
   - VERIFICATION.md Gap 2 truth: "All Phase 3 requirements tested and passing" ✓
   - prompt-builder.test.ts: 8/8 tests passing ✓
</verification>

<success_criteria>
- [ ] Test assertion updated to match actual prompt builder output
- [ ] All 8 tests in prompt-builder.test.ts passing
- [ ] No other tone instruction tests affected
- [ ] VERIFICATION.md Gap 2 closed (non-blocker removed)
- [ ] Phase 3 test suite fully passing (6/6 test files, all tests green)
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-answer-generation/03-07-SUMMARY.md`
</output>
