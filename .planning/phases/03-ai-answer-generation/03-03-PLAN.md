# Plan 03-03: Real AI Providers (OpenAI + Anthropic)

**Phase:** 3 - AI Answer Generation
**Wave:** 2 (parallel with 03-02)
**Priority:** P1 (Should-Have)
**Estimated Duration:** 40 minutes

---

## Goal

Implement OpenAI and Anthropic AI providers using official SDKs. Enable users with API keys to get real AI-generated answers instead of mock templates. Includes API key validation, error handling, retry logic, and proper prompt engineering for each provider's API.

---

## Context

From CONTEXT.md:
- Both OpenAI + Claude support (user chooses provider)
- API key validation with retry (test with real API call before saving)
- Three tone variants with distinct outputs

From RESEARCH.md:
- Use official SDKs: `openai` and `@anthropic-ai/sdk`
- OpenAI: Use `gpt-4o-mini` for cost efficiency
- Anthropic: Use `claude-3-5-sonnet-20241022`
- Set `dangerouslyAllowBrowser: true` for OpenAI in extension context
- Handle rate limits (429 errors)
- Use temperature 0.7 for balance of creativity and consistency
- Generate 3 variants using different prompt phrasings or temperature

---

## Requirements Covered

- REQ-AI-02: User-provided API key support (real AI implementation)
- REQ-AI-03: Role-specific AI tuning (real AI)
- REQ-AI-04: Placeholder markers (enforcement in prompts)
- REQ-AI-05: Essay question handling (real AI)

---

## Tasks

### Task 1: Implement OpenAI Provider
**File:** `src/lib/ai/providers/openai.ts`
**Action:** OpenAI implementation with GPT-4o-mini

```typescript
import OpenAI from 'openai'
import { BaseAIProvider } from './base'
import { PromptBuilder } from '../prompt-builder'
import type { GenerateParams, GenerateResult, AIProvider } from '@/types/ai'

export class OpenAIProvider extends BaseAIProvider {
  readonly name: AIProvider = 'openai'
  readonly supportsStreaming = true
  
  private client: OpenAI
  
  constructor(apiKey: string) {
    super()
    this.client = new OpenAI({
      apiKey,
      dangerouslyAllowBrowser: true // Required for Chrome extension context
    })
  }
  
  async generateAnswer(params: GenerateParams): Promise<GenerateResult> {
    const systemPrompt = PromptBuilder.buildSystemPrompt({
      role: params.role,
      tone: params.tone,
      essayMode: params.essayMode
    })
    
    const promptVariants = PromptBuilder.buildPromptVariants({
      question: params.question,
      questionContext: params.questionContext,
      tone: params.tone
    })
    
    try {
      // Generate 3 variants in parallel
      const drafts = await Promise.all(
        promptVariants.map(async (userPrompt) => {
          const response = await this.client.chat.completions.create({
            model: 'gpt-4o-mini', // Cost-effective for short answers
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: userPrompt }
            ],
            max_tokens: params.essayMode ? 400 : 200,
            temperature: 0.7 // Balance creativity and consistency
          })
          
          const content = response.choices[0]?.message?.content || ''
          
          // Ensure placeholder requirement
          if (!this.validateDraft(content)) {
            console.warn('OpenAI generated draft without placeholders. Appending reminder.')
            return content + '\n\n[Remember to customize with specific details]'
          }
          
          return content
        })
      )
      
      return {
        drafts: drafts as [string, string, string],
        provider: 'openai',
        tones: [params.tone, params.tone, params.tone],
        metadata: {
          essayMode: params.essayMode,
          generatedAt: Date.now(),
          question: params.question
        }
      }
    } catch (error) {
      throw this.handleError(error)
    }
  }
  
  async validateKey(apiKey: string): Promise<boolean> {
    try {
      const testClient = new OpenAI({
        apiKey,
        dangerouslyAllowBrowser: true
      })
      
      // Lightweight validation: list models
      await testClient.models.list()
      return true
    } catch (error) {
      console.error('OpenAI API key validation failed:', error)
      return false
    }
  }
  
  private handleError(error: any): Error {
    if (error.status === 429) {
      return new Error('Rate limit reached. Please wait a moment and try again.')
    }
    
    if (error.status === 401 || error.status === 403) {
      return new Error('Invalid API key. Please check your OpenAI API key in settings.')
    }
    
    if (error.status === 500 || error.status === 503) {
      return new Error('OpenAI service temporarily unavailable. Please try again later.')
    }
    
    return new Error(`OpenAI API error: ${error.message || 'Unknown error'}`)
  }
}
```

**Verification:**
- TypeScript compiles without errors
- Extends BaseAIProvider correctly
- Implements IAIProvider interface

---

### Task 2: Implement Anthropic Provider
**File:** `src/lib/ai/providers/anthropic.ts`
**Action:** Anthropic implementation with Claude

```typescript
import Anthropic from '@anthropic-ai/sdk'
import { BaseAIProvider } from './base'
import { PromptBuilder } from '../prompt-builder'
import type { GenerateParams, GenerateResult, AIProvider } from '@/types/ai'

export class AnthropicProvider extends BaseAIProvider {
  readonly name: AIProvider = 'anthropic'
  readonly supportsStreaming = true
  
  private client: Anthropic
  
  constructor(apiKey: string) {
    super()
    this.client = new Anthropic({
      apiKey
    })
  }
  
  async generateAnswer(params: GenerateParams): Promise<GenerateResult> {
    const systemPrompt = PromptBuilder.buildSystemPrompt({
      role: params.role,
      tone: params.tone,
      essayMode: params.essayMode
    })
    
    const promptVariants = PromptBuilder.buildPromptVariants({
      question: params.question,
      questionContext: params.questionContext,
      tone: params.tone
    })
    
    try {
      // Generate 3 variants in parallel
      const drafts = await Promise.all(
        promptVariants.map(async (userPrompt) => {
          const message = await this.client.messages.create({
            model: 'claude-3-5-sonnet-20241022', // Latest Sonnet
            max_tokens: params.essayMode ? 400 : 200,
            system: systemPrompt, // Anthropic uses separate system parameter
            messages: [
              { role: 'user', content: userPrompt }
            ]
          })
          
          const content = message.content[0]?.type === 'text' 
            ? message.content[0].text 
            : ''
          
          // Ensure placeholder requirement
          if (!this.validateDraft(content)) {
            console.warn('Anthropic generated draft without placeholders. Appending reminder.')
            return content + '\n\n[Remember to customize with specific details]'
          }
          
          return content
        })
      )
      
      return {
        drafts: drafts as [string, string, string],
        provider: 'anthropic',
        tones: [params.tone, params.tone, params.tone],
        metadata: {
          essayMode: params.essayMode,
          generatedAt: Date.now(),
          question: params.question
        }
      }
    } catch (error) {
      throw this.handleError(error)
    }
  }
  
  async validateKey(apiKey: string): Promise<boolean> {
    try {
      const testClient = new Anthropic({ apiKey })
      
      // Lightweight validation: minimal message request
      await testClient.messages.create({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 10,
        messages: [
          { role: 'user', content: 'test' }
        ]
      })
      
      return true
    } catch (error) {
      console.error('Anthropic API key validation failed:', error)
      return false
    }
  }
  
  private handleError(error: any): Error {
    if (error.status === 429) {
      return new Error('Rate limit reached. Please wait a moment and try again.')
    }
    
    if (error.status === 401 || error.status === 403) {
      return new Error('Invalid API key. Please check your Anthropic API key in settings.')
    }
    
    if (error.status === 500 || error.status === 503) {
      return new Error('Anthropic service temporarily unavailable. Please try again later.')
    }
    
    return new Error(`Anthropic API error: ${error.message || 'Unknown error'}`)
  }
}
```

**Verification:**
- TypeScript compiles without errors
- Extends BaseAIProvider correctly
- Implements IAIProvider interface

---

### Task 3: Update Factory to Support Real Providers
**File:** `src/lib/ai/factory.ts`
**Action:** Uncomment provider instantiation

```typescript
import type { IAIProvider, AIProvider } from '@/types/ai'
import { getAIConfig, getAPIKey } from './config'
import { MockProvider } from './providers/mock'
import { OpenAIProvider } from './providers/openai'
import { AnthropicProvider } from './providers/anthropic'

/**
 * Get the appropriate AI provider based on current configuration
 */
export async function getAIProvider(): Promise<IAIProvider> {
  const config = await getAIConfig()
  
  switch (config.provider) {
    case 'openai': {
      const apiKey = await getAPIKey('openai')
      if (!apiKey) {
        // Fall back to mock if no key
        console.warn('OpenAI provider selected but no API key found. Falling back to mock.')
        return new MockProvider()
      }
      return new OpenAIProvider(apiKey)
    }
    
    case 'anthropic': {
      const apiKey = await getAPIKey('anthropic')
      if (!apiKey) {
        console.warn('Anthropic provider selected but no API key found. Falling back to mock.')
        return new MockProvider()
      }
      return new AnthropicProvider(apiKey)
    }
    
    case 'mock':
    default:
      return new MockProvider()
  }
}

/**
 * Create provider instance for validation (doesn't save to config)
 */
export async function createProviderForValidation(
  provider: 'openai' | 'anthropic',
  apiKey: string
): Promise<IAIProvider> {
  switch (provider) {
    case 'openai':
      return new OpenAIProvider(apiKey)
    
    case 'anthropic':
      return new AnthropicProvider(apiKey)
    
    default:
      throw new Error(`Unknown provider: ${provider}`)
  }
}
```

**Verification:**
- All providers instantiate correctly
- Factory returns correct provider based on config

---

### Task 4: Export Providers from Index
**File:** `src/lib/ai/index.ts`
**Action:** Export provider classes

```typescript
// Types
export type {
  AIProvider,
  ToneVariant,
  RoleType,
  GenerateParams,
  GenerateResult,
  AIConfig,
  IAIProvider,
  ValidationResult
} from '@/types/ai'

// Configuration
export {
  getAIConfig,
  setAIProvider,
  saveAPIKey,
  getAPIKey,
  clearAPIKey,
  hasValidKey,
  getActiveProvider
} from './config'

// Factory
export {
  getAIProvider,
  createProviderForValidation
} from './factory'

// Base (for extending)
export { BaseAIProvider } from './providers/base'

// Providers (for testing)
export { MockProvider } from './providers/mock'
export { OpenAIProvider } from './providers/openai'
export { AnthropicProvider } from './providers/anthropic'

// Utilities
export { PromptBuilder } from './prompt-builder'
```

---

### Task 5: Create Integration Tests
**File:** `src/lib/ai/providers/integration.test.ts`
**Action:** Test real providers (skipped in CI, manual testing)

```typescript
import { describe, it, expect } from 'vitest'
import { OpenAIProvider } from './openai'
import { AnthropicProvider } from './anthropic'
import type { GenerateParams } from '@/types/ai'
import type { Profile } from '@/types/profile'

/**
 * Integration tests for real AI providers
 * 
 * These tests are SKIPPED by default because they:
 * 1. Require valid API keys
 * 2. Cost money to run
 * 3. Depend on external services
 * 
 * To run manually:
 * 1. Set OPENAI_API_KEY and ANTHROPIC_API_KEY environment variables
 * 2. Run: pnpm test src/lib/ai/providers/integration.test.ts
 * 3. Remove .skip from describe()
 */
describe.skip('Real AI Providers Integration', () => {
  const mockProfile: Profile = {
    personalInfo: {
      fullName: 'Test User',
      email: 'test@example.com',
      phone: '555-1234',
      location: 'San Francisco'
    },
    workExperience: [],
    education: [],
    skills: ['TypeScript', 'React', 'Node.js'],
    links: {},
    rolePreference: 'tech'
  }
  
  const baseParams: GenerateParams = {
    question: 'Why do you want to work at our company?',
    userProfile: mockProfile,
    tone: 'professional',
    essayMode: false,
    role: 'tech'
  }
  
  describe('OpenAIProvider', () => {
    const apiKey = process.env.OPENAI_API_KEY
    
    it('should validate correct API key', async () => {
      if (!apiKey) {
        console.warn('Skipping: OPENAI_API_KEY not set')
        return
      }
      
      const provider = new OpenAIProvider(apiKey)
      const isValid = await provider.validateKey!(apiKey)
      
      expect(isValid).toBe(true)
    })
    
    it('should generate 3 distinct drafts', async () => {
      if (!apiKey) {
        console.warn('Skipping: OPENAI_API_KEY not set')
        return
      }
      
      const provider = new OpenAIProvider(apiKey)
      const result = await provider.generateAnswer(baseParams)
      
      expect(result.drafts).toHaveLength(3)
      expect(result.provider).toBe('openai')
      
      // Check drafts are distinct
      expect(result.drafts[0]).not.toBe(result.drafts[1])
      expect(result.drafts[1]).not.toBe(result.drafts[2])
    })
    
    it('should include placeholders in drafts', async () => {
      if (!apiKey) {
        console.warn('Skipping: OPENAI_API_KEY not set')
        return
      }
      
      const provider = new OpenAIProvider(apiKey)
      const result = await provider.generateAnswer(baseParams)
      
      // At least one draft should have placeholders
      const placeholderPattern = /\[.*?\]/
      const hasPlaceholders = result.drafts.some(draft => 
        placeholderPattern.test(draft)
      )
      
      expect(hasPlaceholders).toBe(true)
    })
  })
  
  describe('AnthropicProvider', () => {
    const apiKey = process.env.ANTHROPIC_API_KEY
    
    it('should validate correct API key', async () => {
      if (!apiKey) {
        console.warn('Skipping: ANTHROPIC_API_KEY not set')
        return
      }
      
      const provider = new AnthropicProvider(apiKey)
      const isValid = await provider.validateKey!(apiKey)
      
      expect(isValid).toBe(true)
    })
    
    it('should generate 3 distinct drafts', async () => {
      if (!apiKey) {
        console.warn('Skipping: ANTHROPIC_API_KEY not set')
        return
      }
      
      const provider = new AnthropicProvider(apiKey)
      const result = await provider.generateAnswer(baseParams)
      
      expect(result.drafts).toHaveLength(3)
      expect(result.provider).toBe('anthropic')
      
      // Check drafts are distinct
      expect(result.drafts[0]).not.toBe(result.drafts[1])
      expect(result.drafts[1]).not.toBe(result.drafts[2])
    })
    
    it('should include placeholders in drafts', async () => {
      if (!apiKey) {
        console.warn('Skipping: ANTHROPIC_API_KEY not set')
        return
      }
      
      const provider = new AnthropicProvider(apiKey)
      const result = await provider.generateAnswer(baseParams)
      
      // At least one draft should have placeholders
      const placeholderPattern = /\[.*?\]/
      const hasPlaceholders = result.drafts.some(draft => 
        placeholderPattern.test(draft)
      )
      
      expect(hasPlaceholders).toBe(true)
    })
  })
})
```

---

### Task 6: Create Provider Error Handling Tests
**File:** `src/lib/ai/providers/errors.test.ts`
**Action:** Test error handling without real API calls

```typescript
import { describe, it, expect, vi } from 'vitest'
import { OpenAIProvider } from './openai'
import { AnthropicProvider } from './anthropic'

describe('Provider Error Handling', () => {
  describe('OpenAIProvider', () => {
    it('should handle rate limit errors', async () => {
      const provider = new OpenAIProvider('test-key')
      
      // Mock client to throw rate limit error
      vi.spyOn(provider['client'].chat.completions, 'create').mockRejectedValue({
        status: 429,
        message: 'Rate limit exceeded'
      })
      
      await expect(
        provider.generateAnswer({
          question: 'Test',
          userProfile: {} as any,
          tone: 'professional',
          essayMode: false,
          role: 'tech'
        })
      ).rejects.toThrow('Rate limit reached')
    })
    
    it('should handle invalid API key errors', async () => {
      const provider = new OpenAIProvider('invalid-key')
      
      vi.spyOn(provider['client'].chat.completions, 'create').mockRejectedValue({
        status: 401,
        message: 'Invalid API key'
      })
      
      await expect(
        provider.generateAnswer({
          question: 'Test',
          userProfile: {} as any,
          tone: 'professional',
          essayMode: false,
          role: 'tech'
        })
      ).rejects.toThrow('Invalid API key')
    })
  })
  
  describe('AnthropicProvider', () => {
    it('should handle rate limit errors', async () => {
      const provider = new AnthropicProvider('test-key')
      
      vi.spyOn(provider['client'].messages, 'create').mockRejectedValue({
        status: 429,
        message: 'Rate limit exceeded'
      })
      
      await expect(
        provider.generateAnswer({
          question: 'Test',
          userProfile: {} as any,
          tone: 'professional',
          essayMode: false,
          role: 'tech'
        })
      ).rejects.toThrow('Rate limit reached')
    })
    
    it('should handle invalid API key errors', async () => {
      const provider = new AnthropicProvider('invalid-key')
      
      vi.spyOn(provider['client'].messages, 'create').mockRejectedValue({
        status: 401,
        message: 'Invalid API key'
      })
      
      await expect(
        provider.generateAnswer({
          question: 'Test',
          userProfile: {} as any,
          tone: 'professional',
          essayMode: false,
          role: 'tech'
        })
      ).rejects.toThrow('Invalid API key')
    })
  })
})
```

---

## Dependencies

- Plan 03-01 complete (infrastructure)
- Plan 03-02 complete (PromptBuilder)
- OpenAI and Anthropic SDKs installed

---

## Success Criteria

- [ ] All TypeScript files compile without errors
- [ ] `pnpm type-check` passes
- [ ] Unit tests pass (error handling tests)
- [ ] OpenAI provider implements interface correctly
- [ ] Anthropic provider implements interface correctly
- [ ] API key validation works for both providers
- [ ] Error handling works for common API errors (401, 429, 500)
- [ ] Factory returns correct provider instance
- [ ] Integration tests documented (skipped in CI)

---

## Manual Testing Checklist

After implementation, test with real API keys:

1. **OpenAI validation:**
   - Valid key → validation succeeds
   - Invalid key → validation fails with clear error
   
2. **Anthropic validation:**
   - Valid key → validation succeeds
   - Invalid key → validation fails with clear error
   
3. **OpenAI generation:**
   - Short answer → 3 distinct drafts
   - Essay mode → STAR outlines
   - All drafts include placeholders
   
4. **Anthropic generation:**
   - Short answer → 3 distinct drafts
   - Essay mode → STAR outlines
   - All drafts include placeholders

---

## Non-Goals (Deferred to Later Plans)

- Question detection logic (Plan 03-04)
- UI components for "Suggest Answer" button (Plan 03-04)
- Settings UI for API key configuration (Plan 03-05)

---

## Rollback Plan

If critical issues found:
1. Revert commit for this plan
2. Keep Plans 03-01 and 03-02
3. Remove `src/lib/ai/providers/openai.ts` and `anthropic.ts`
4. Restore factory to throw errors for unimplemented providers

---

**End of Plan 03-03**
