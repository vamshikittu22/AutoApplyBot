---
phase: 00-foundation-setup
plan: 03
type: execute
wave: 3
depends_on: ["00-02"]
files_modified:
  - vitest.config.ts
  - playwright.config.ts
  - package.json
  - tests/unit/example.test.ts
  - tests/e2e/extension-loads.spec.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests can run with browser API mocks"
    - "E2E tests can load the extension in a real browser"
    - "All test commands from AGENTS.md work"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration with WXT browser mocks"
      contains: "WxtVitest"
    - path: "playwright.config.ts"
      provides: "Playwright configuration for E2E tests"
      min_lines: 30
    - path: "tests/unit/example.test.ts"
      provides: "Example unit test verifying setup"
      contains: "describe"
    - path: "tests/e2e/extension-loads.spec.ts"
      provides: "Example E2E test verifying extension loads"
      contains: "test"
  key_links:
    - from: "vitest.config.ts"
      to: "WxtVitest()"
      via: "plugin import"
      pattern: "WxtVitest"
    - from: "tests/unit/example.test.ts"
      to: "fakeBrowser"
      via: "WXT testing import"
      pattern: "wxt/testing"
---

<objective>
Configure Vitest for unit testing with WXT browser API mocks, set up Playwright for E2E testing of the extension in real Chrome, and create example tests to verify the testing infrastructure works.

Purpose: Establish testing foundation required for Phase 1+ development. Per AGENTS.md: "Unit tests required for all ATS detection logic, field mapping, and encryption." This plan ensures test infrastructure is ready before feature development begins.

Output: Fully configured Vitest with WXT's `fakeBrowser` polyfills, Playwright configured to load the extension in Chrome, example tests passing, and all test commands from AGENTS.md functional.
</objective>

<execution_context>
@C:/Users/kittu/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/kittu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/kittu/Downloads/GIT/AutoApplyBot/.planning/PROJECT.md
@C:/Users/kittu/Downloads/GIT/AutoApplyBot/.planning/ROADMAP.md
@C:/Users/kittu/Downloads/GIT/AutoApplyBot/.planning/phases/00-foundation-setup/00-CONTEXT.md
@C:/Users/kittu/Downloads/GIT/AutoApplyBot/.planning/phases/00-foundation-setup/00-RESEARCH.md
@C:/Users/kittu/Downloads/GIT/AutoApplyBot/TECHSTACK.md
@C:/Users/kittu/Downloads/GIT/AutoApplyBot/AGENTS.md

# Reference from Plan 01 for structure context
@C:/Users/kittu/Downloads/GIT/AutoApplyBot/.planning/phases/00-foundation-setup/00-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Configure Vitest with WXT browser API mocks</name>
  <files>
    vitest.config.ts
    package.json
  </files>
  <action>
Install Vitest and WXT testing utilities:

```bash
pnpm add -D vitest @vitest/ui jsdom @types/node
```

Create vitest.config.ts in project root per RESEARCH.md Pattern 3:

```typescript
import { defineConfig } from 'vitest/config';
import { WxtVitest } from 'wxt/testing';

export default defineConfig({
  plugins: [WxtVitest()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: [],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      include: ['src/**/*.{ts,tsx}'],
      exclude: [
        'src/**/*.test.{ts,tsx}',
        'src/entrypoints/**', // Entrypoints tested via E2E
        'src/**/*.d.ts',
      ],
    },
  },
});
```

Add test scripts to package.json per AGENTS.md:

```json
"scripts": {
  "test": "vitest run",
  "test:watch": "vitest",
  "test:ui": "vitest --ui",
  "test:coverage": "vitest run --coverage"
}
```

Rationale: WXT provides `WxtVitest()` plugin that automatically polyfills `browser.*` APIs (chrome.storage, chrome.runtime, etc.) using `@webext-core/fake-browser`. Per RESEARCH.md: "No need to manually mock `chrome.storage` — `fakeBrowser` provides in-memory implementation." This is critical for testing storage encryption and ATS detection logic in future phases.
  </action>
  <verify>
Run `pnpm test` (should pass with zero tests for now).

Check vitest.config.ts:
- Contains `WxtVitest()` plugin
- environment: 'jsdom' for DOM testing
- Coverage configured to exclude test files and entrypoints

Verify package.json has test, test:watch, test:ui scripts.
  </verify>
  <done>
- Vitest installed with WXT plugin
- vitest.config.ts configured with jsdom environment and coverage
- WxtVitest() plugin imported and active
- Test scripts added to package.json
- `pnpm test` runs successfully (zero tests)
  </done>
</task>

<task type="auto">
  <name>Create example unit test using WXT browser mocks</name>
  <files>
    tests/unit/example.test.ts
  </files>
  <action>
Create a simple unit test that verifies Vitest and WXT browser mocks work correctly.

Create `tests/unit/example.test.ts`:

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { fakeBrowser } from 'wxt/testing';

describe('WXT Testing Infrastructure', () => {
  beforeEach(() => {
    // Reset fake browser state before each test
    fakeBrowser.reset();
  });

  it('should have access to browser.runtime API', () => {
    expect(fakeBrowser.runtime).toBeDefined();
    expect(fakeBrowser.runtime.id).toBeDefined();
  });

  it('should mock chrome.storage.local API', async () => {
    const testData = { key: 'value' };
    
    // Write to fake storage
    await fakeBrowser.storage.local.set(testData);
    
    // Read from fake storage
    const result = await fakeBrowser.storage.local.get('key');
    
    expect(result.key).toBe('value');
  });

  it('should isolate storage between tests', async () => {
    // This test should not see data from previous test
    const result = await fakeBrowser.storage.local.get('key');
    expect(result.key).toBeUndefined();
  });
});
```

Rationale: This test verifies that WXT's browser API mocks work correctly. Per RESEARCH.md: "Tests run in Node without browser dependency." This example demonstrates the pattern that will be used extensively in Phase 1 (profile storage) and Phase 2 (ATS detection).
  </action>
  <verify>
Run `pnpm test` and confirm:
1. All 3 tests pass
2. Console shows "3 passed" (not "0 passed")
3. No errors about missing browser APIs
4. Storage isolation test passes (confirms fakeBrowser.reset() works)

Run `pnpm test:watch` briefly to confirm watch mode works, then exit.
  </verify>
  <done>
- tests/unit/example.test.ts created
- 3 tests defined and passing
- `pnpm test` shows "3 passed"
- WXT browser mocks functional (storage API test passes)
- Test isolation verified (reset() works between tests)
  </done>
</task>

<task type="auto">
  <name>Configure Playwright for E2E testing with extension support</name>
  <files>
    playwright.config.ts
    tests/e2e/extension-loads.spec.ts
    package.json
  </files>
  <action>
Install Playwright:

```bash
pnpm add -D playwright @playwright/test
pnpm exec playwright install chromium
```

Create playwright.config.ts in project root:

```typescript
import { defineConfig, devices } from '@playwright/test';
import path from 'path';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: false, // Extensions can't run in parallel (same profile)
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: 1, // One worker for extension tests
  reporter: 'html',
  use: {
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },

  projects: [
    {
      name: 'chromium-extension',
      use: {
        ...devices['Desktop Chrome'],
        // Extension will be loaded via launchOptions in test files
      },
    },
  ],
});
```

Create example E2E test `tests/e2e/extension-loads.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import path from 'path';
import { chromium, type BrowserContext } from 'playwright';

const extensionPath = path.join(__dirname, '../../.output/chrome-mv3');

test.describe('Extension Loading', () => {
  let context: BrowserContext;

  test.beforeAll(async () => {
    // Launch Chrome with extension loaded
    context = await chromium.launchPersistentContext('', {
      headless: false, // Extensions require headed mode
      args: [
        `--disable-extensions-except=${extensionPath}`,
        `--load-extension=${extensionPath}`,
      ],
    });
  });

  test.afterAll(async () => {
    await context.close();
  });

  test('extension should load without errors', async () => {
    const page = await context.newPage();
    
    // Check for extension errors in console
    const errors: string[] = [];
    page.on('console', (msg) => {
      if (msg.type() === 'error') {
        errors.push(msg.text());
      }
    });
    
    await page.goto('https://example.com');
    await page.waitForTimeout(2000); // Wait for extension to initialize
    
    // Verify no extension errors
    const extensionErrors = errors.filter(e => 
      e.includes('chrome-extension://') || e.includes('Extension context')
    );
    expect(extensionErrors).toHaveLength(0);
  });

  test('background service worker should be active', async () => {
    const serviceWorker = context.serviceWorkers()[0];
    expect(serviceWorker).toBeDefined();
  });
});
```

Add E2E test scripts to package.json per AGENTS.md:

```json
"scripts": {
  "test:e2e": "playwright test",
  "test:e2e:headed": "playwright test --headed",
  "test:e2e:ui": "playwright test --ui"
}
```

Rationale: Playwright tests verify the extension works in a real Chrome browser. Per TECHSTACK.md: "Test real extension behavior on Workday/Greenhouse/Lever pages" in future phases. Extension testing requires headed mode (extensions don't work in headless Chrome) and persistent context (to load the extension).
  </action>
  <verify>
Build the extension first: `pnpm build` (creates .output/chrome-mv3)

Run `pnpm test:e2e` and confirm:
1. Chrome opens in headed mode (you'll see the browser window)
2. Extension loads (check chrome://extensions in the opened browser)
3. Both E2E tests pass ("extension should load without errors", "background service worker should be active")
4. No extension-related console errors

If tests fail with "extension path not found", ensure `pnpm build` was run before testing.
  </verify>
  <done>
- Playwright installed with chromium browser
- playwright.config.ts configured for extension testing
- tests/e2e/extension-loads.spec.ts created with 2 tests
- E2E test scripts added to package.json
- `pnpm test:e2e` passes (both tests green)
- Extension loads successfully in Playwright Chrome instance
  </done>
</task>

</tasks>

<verification>
**Plan 03 Goal:** Testing infrastructure functional (Vitest + Playwright)

**Verification Steps:**
1. Run `pnpm test` → 3 unit tests pass (WXT browser mock tests)
2. Run `pnpm build` → extension builds to .output/chrome-mv3
3. Run `pnpm test:e2e` → 2 E2E tests pass, Chrome opens with extension loaded
4. Run `pnpm test:watch` → Vitest watch mode active (exit with 'q')
5. Check test coverage: `pnpm test:coverage` → coverage report generated (currently 0% since no real code yet)
6. Verify all AGENTS.md test commands work:
   - `pnpm test` ✅
   - `pnpm test:watch` ✅
   - `pnpm test:e2e` ✅
   - `pnpm test:e2e:headed` ✅

**Success Criteria:**
- Vitest runs unit tests with WXT browser mocks
- Playwright runs E2E tests with extension loaded
- All test commands functional
- Example tests demonstrate patterns for future phases
</verification>

<success_criteria>
**Measurable Completion:**
1. ✅ Vitest configured with WxtVitest() plugin
2. ✅ vitest.config.ts has jsdom environment and coverage settings
3. ✅ Example unit test passes (3 tests verifying browser mocks)
4. ✅ Playwright configured with extension support
5. ✅ playwright.config.ts uses persistent context for extension loading
6. ✅ Example E2E test passes (2 tests verifying extension loads)
7. ✅ All test commands from AGENTS.md work (test, test:watch, test:e2e, test:e2e:headed)
8. ✅ `fakeBrowser` API functional (storage test passes)
9. ✅ Extension loads in Playwright Chrome without errors
10. ✅ Test isolation verified (beforeEach reset works)

**Phase 0 Definition of Done alignment:**
- All Phase 0 requirements now complete ✅
- Extension loads in Chrome without errors (Plan 01) ✅
- `pnpm dev` starts with hot reload (Plan 01) ✅
- TypeScript strict mode passes (Plan 02) ✅
- ESLint and Prettier configured (Plan 02) ✅
- Git repository initialized (pre-existing) ✅
- WXT framework configured (Plan 01) ✅
- Basic manifest.json created (Plan 01) ✅
- Testing infrastructure ready for Phase 1 ✅
</success_criteria>

<output>
After completion, create `.planning/phases/00-foundation-setup/00-03-SUMMARY.md` documenting:
- Vitest configuration and WXT plugin integration
- Example unit tests created (list all tests)
- Playwright configuration for extension testing
- Example E2E tests created (list all tests)
- Test execution results (pass/fail counts)
- Any issues encountered during Playwright setup
- Coverage configuration details
- All test commands verified working
- Files created
</output>
